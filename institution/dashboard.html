<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="USDI Institution Dashboard - Manage Student Records">
    <title>Institution Dashboard - USDI</title>
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="../css/liquid-bg.css">
    <link rel="stylesheet" href="../css/button-anim.css">
    <link rel="stylesheet" href="../css/morph-nav.css"> <!-- For consistency if needed -->
</head>

<body>
    <!-- Header -->
    <header class="header transparent-header" role="banner">
        <div class="container" style="display: flex; justify-content: space-between; align-items: center;">
            <a href="../index.html" class="logo" aria-label="USDI Home">
                <div class="logo-icon" aria-hidden="true">üéì</div>
                <span>USDI</span>
            </a>

            <!-- Morphing Navigation -->
            <nav class="nav morph-nav" role="navigation" aria-label="Main navigation">
                <ul>
                    <li><a href="../index.html" class="active">Dashboard</a></li>

                    <!-- Language Dropdown -->
                    <li>
                        <div class="language-wrapper" style="margin: 0;">
                            <div class="custom-dropdown" id="language-dropdown">
                                <div class="dropdown-trigger" role="button" aria-haspopup="listbox"
                                    aria-expanded="false" tabindex="0">
                                    <span>üåê English</span>
                                    <span class="dropdown-icon">‚ñº</span>
                                </div>
                                <div class="dropdown-options" role="listbox">
                                    <div class="dropdown-option selected" data-value="en" role="option"
                                        aria-selected="true" tabindex="0">
                                        <span>English</span>
                                    </div>
                                    <div class="dropdown-option" data-value="ml" role="option" aria-selected="false"
                                        tabindex="0">
                                        <span>‡¥Æ‡¥≤‡¥Ø‡¥æ‡¥≥‡¥Ç</span>
                                    </div>
                                    <div class="dropdown-option" data-value="hi" role="option" aria-selected="false"
                                        tabindex="0">
                                        <span>‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </li>

                    <!-- Flat Theme Switcher -->
                    <li>
                        <label class="switch">
                            <input class="switch__input" type="checkbox" role="switch"
                                onchange="toggleTheme(this.checked)" />
                            <span class="switch__icon">
                                <span class="switch__icon-part switch__icon-part--1"></span>
                                <span class="switch__icon-part switch__icon-part--2"></span>
                                <span class="switch__icon-part switch__icon-part--3"></span>
                                <span class="switch__icon-part switch__icon-part--4"></span>
                                <span class="switch__icon-part switch__icon-part--5"></span>
                                <span class="switch__icon-part switch__icon-part--6"></span>
                                <span class="switch__icon-part switch__icon-part--7"></span>
                                <span class="switch__icon-part switch__icon-part--8"></span>
                                <span class="switch__icon-part switch__icon-part--9"></span>
                                <span class="switch__icon-part switch__icon-part--10"></span>
                                <span class="switch__icon-part switch__icon-part--11"></span>
                            </span>
                            <span class="switch__sr">Dark Mode</span>
                        </label>
                    </li>
                </ul>
            </nav>

            <button class="menu-toggle" onclick="toggleMobileMenu()" aria-label="Toggle Menu">
                <span></span>
                <span></span>
                <span></span>
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="dashboard">
        <div class="container">
            <!-- Header -->
            <div class="dashboard-header flex justify-between items-center">
                <div class="flex items-center">
                    <a href="login.html" class="btn-back">‚Üê</a>
                    <div>
                        <h1 class="dashboard-title">Institution Dashboard</h1>
                        <p class="dashboard-subtitle" id="institution-name">National Institute of Technology</p>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="openAddModal()">
                    + Add New Student
                </button>
            </div>

            <!-- Stats Cards -->
            <div class="grid grid-4 mb-8" id="stats-cards">
                <div class="stat-card">
                    <div class="stat-value" id="stat-total">0</div>
                    <div class="stat-label">Total Students</div>
                </div>
                <div class="stat-card success">
                    <div class="stat-value" id="stat-active">0</div>
                    <div class="stat-label">Active</div>
                </div>
                <div class="stat-card info">
                    <div class="stat-value" id="stat-graduated">0</div>
                    <div class="stat-label">Graduated</div>
                </div>
                <div class="stat-card warning">
                    <div class="stat-value" id="stat-other">0</div>
                    <div class="stat-label">Transferred/Discontinued</div>
                </div>
            </div>

            <!-- Pending Verifications Section -->
            <div class="card mb-6" id="pending-section">
                <div class="card-header"
                    style="background: linear-gradient(135deg, #fef3c7, #fde68a); border-left: 4px solid #f59e0b;">
                    <h3 style="margin: 0; color: #92400e;">
                        ‚è≥ Pending Student Verifications
                        <span class="badge badge-warning" id="pending-count" style="margin-left: 10px;">0</span>
                    </h3>
                </div>
                <div class="card-body" style="padding: 0;">
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Mobile</th>
                                    <th>Course</th>
                                    <th>Submitted</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="pending-table">
                                <!-- Pending rows will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Student List -->
            <div class="card">
                <div class="card-header flex justify-between items-center">
                    <h3 style="margin: 0;">Student Records</h3>
                    <div style="display: flex; gap: var(--space-3); align-items: center;">
                        <button class="btn btn-secondary" onclick="exportToCSV()"
                            style="background: #059669; color: #fff;">
                            üìä Export CSV
                        </button>
                        <div class="search-box" style="width: 300px;">
                            <span class="search-icon">üîç</span>
                            <input type="text" id="search-input" class="form-input"
                                placeholder="Search by name or USN..." oninput="filterStudents()">
                        </div>
                    </div>
                </div>
                <div class="card-body" style="padding: 0;">
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>USN</th>
                                    <th>Name</th>
                                    <th>Course</th>
                                    <th>Semester/Year</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="students-table">
                                <!-- Student rows will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Add Student Modal -->
    <div class="modal-overlay" id="add-modal">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h3 class="modal-title">Add New Student</h3>
                <button class="modal-close" onclick="closeAddModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div
                    style="background: var(--info-light); color: var(--info); padding: var(--space-3); border-radius: var(--radius); margin-bottom: var(--space-4);">
                    <strong>USN will be auto-generated:</strong> <span id="preview-usn">USDI2026XXX</span>
                </div>
                <form id="add-form" onsubmit="handleAddStudent(event)">
                    <div class="grid" style="grid-template-columns: 1fr 1fr; gap: var(--space-4);">
                        <div class="form-group">
                            <label class="form-label">Full Name *</label>
                            <input type="text" id="add-name" class="form-input" placeholder="Enter full name" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Date of Birth *</label>
                            <input type="date" id="add-dob" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Mobile Number *</label>
                            <input type="tel" id="add-mobile" class="form-input" placeholder="10-digit mobile"
                                maxlength="10" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Course *</label>
                            <select id="add-course" class="form-select" required>
                                <option value="">Select Course</option>
                                <option value="B.Tech Computer Science">B.Tech Computer Science</option>
                                <option value="B.Tech Electronics">B.Tech Electronics</option>
                                <option value="B.Tech Mechanical">B.Tech Mechanical</option>
                                <option value="B.Tech Civil">B.Tech Civil</option>
                                <option value="B.Tech Information Technology">B.Tech Information Technology</option>
                                <option value="B.Tech Electrical">B.Tech Electrical</option>
                                <option value="MBA">MBA</option>
                                <option value="MCA">MCA</option>
                            </select>
                        </div>
                        <div class="form-group" style="grid-column: span 2;">
                            <label class="form-label">Semester/Year *</label>
                            <select id="add-semester" class="form-select" required>
                                <option value="">Select Semester</option>
                                <option value="1st Semester">1st Semester</option>
                                <option value="2nd Semester">2nd Semester</option>
                                <option value="3rd Semester">3rd Semester</option>
                                <option value="4th Semester">4th Semester</option>
                                <option value="5th Semester">5th Semester</option>
                                <option value="6th Semester">6th Semester</option>
                                <option value="7th Semester">7th Semester</option>
                                <option value="8th Semester">8th Semester</option>
                                <option value="1st Year">1st Year</option>
                                <option value="2nd Year">2nd Year</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer"
                        style="padding: var(--space-4) 0 0; border: 0; margin-top: var(--space-4);">
                        <button type="button" class="btn btn-secondary" onclick="closeAddModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Add Student</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Student Modal (Full Academic Details) -->
    <div class="modal-overlay" id="edit-modal">
        <div class="modal" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h3 class="modal-title">üìù Edit Student - Full Academic Details</h3>
                <button class="modal-close" onclick="closeEditModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div
                    style="background: var(--primary-light); color: var(--primary); padding: var(--space-3); border-radius: var(--radius); margin-bottom: var(--space-4);">
                    <strong>USN:</strong> <span id="edit-usn-display">-</span> |
                    <strong>Student:</strong> <span id="edit-name-display">-</span>
                </div>
                <form id="edit-form" onsubmit="handleEditStudent(event)">
                    <input type="hidden" id="edit-usn">

                    <!-- Personal Details Section -->
                    <h4
                        style="margin-bottom: var(--space-3); color: var(--grey-700); border-bottom: 2px solid var(--grey-200); padding-bottom: var(--space-2);">
                        üë§ Personal Details</h4>
                    <div class="grid"
                        style="grid-template-columns: 1fr 1fr; gap: var(--space-4); margin-bottom: var(--space-6);">
                        <div class="form-group">
                            <label class="form-label">Full Name *</label>
                            <input type="text" id="edit-fullname" class="form-input" placeholder="Enter full name"
                                required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Date of Birth</label>
                            <input type="date" id="edit-dob" class="form-input">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Gender</label>
                            <select id="edit-gender" class="form-select">
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Mobile Number</label>
                            <input type="tel" id="edit-mobile" class="form-input" placeholder="10-digit mobile"
                                maxlength="10">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email ID</label>
                            <input type="email" id="edit-email" class="form-input" placeholder="Email address">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Category</label>
                            <select id="edit-category" class="form-select">
                                <option value="General">General</option>
                                <option value="OBC">OBC</option>
                                <option value="SC">SC</option>
                                <option value="ST">ST</option>
                                <option value="EWS">EWS</option>
                            </select>
                        </div>
                    </div>

                    <!-- Institution Details Section -->
                    <h4
                        style="margin-bottom: var(--space-3); color: var(--grey-700); border-bottom: 2px solid var(--grey-200); padding-bottom: var(--space-2);">
                        üè´ Institution & Course Details</h4>
                    <div class="grid"
                        style="grid-template-columns: 1fr 1fr; gap: var(--space-4); margin-bottom: var(--space-6);">
                        <div class="form-group" style="grid-column: span 2;">
                            <label class="form-label">Institution Name</label>
                            <input type="text" id="edit-institution" class="form-input" placeholder="Institution name">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Institution Type</label>
                            <select id="edit-inst-type" class="form-select">
                                <option value="Government Polytechnic">Government Polytechnic</option>
                                <option value="Private Polytechnic">Private Polytechnic</option>
                                <option value="Government Engineering College">Government Engineering College</option>
                                <option value="Private Engineering College">Private Engineering College</option>
                                <option value="University">University</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Affiliated Authority</label>
                            <input type="text" id="edit-authority" class="form-input" placeholder="e.g., DTE Kerala">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Course *</label>
                            <select id="edit-course" class="form-select" required>
                                <option value="Diploma in Computer Engineering">Diploma in Computer Engineering</option>
                                <option value="Diploma in Electronics">Diploma in Electronics</option>
                                <option value="Diploma in Mechanical">Diploma in Mechanical</option>
                                <option value="Diploma in Civil">Diploma in Civil</option>
                                <option value="Diploma in Electrical">Diploma in Electrical</option>
                                <option value="B.Tech Computer Science">B.Tech Computer Science</option>
                                <option value="B.Tech Electronics">B.Tech Electronics</option>
                                <option value="B.Tech Mechanical">B.Tech Mechanical</option>
                                <option value="B.Tech Civil">B.Tech Civil</option>
                                <option value="B.Tech Information Technology">B.Tech Information Technology</option>
                                <option value="B.Tech Electrical">B.Tech Electrical</option>
                                <option value="MBA">MBA</option>
                                <option value="MCA">MCA</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Branch Code</label>
                            <input type="text" id="edit-branch" class="form-input" placeholder="e.g., DC, CS">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Current Semester/Year *</label>
                            <select id="edit-semester" class="form-select" required>
                                <option value="Semester 1">Semester 1</option>
                                <option value="Semester 2">Semester 2</option>
                                <option value="Semester 3">Semester 3</option>
                                <option value="Semester 4">Semester 4</option>
                                <option value="Semester 5">Semester 5</option>
                                <option value="Semester 6">Semester 6</option>
                                <option value="Semester 7">Semester 7</option>
                                <option value="Semester 8">Semester 8</option>
                                <option value="Completed">Completed</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Mode of Study</label>
                            <select id="edit-mode" class="form-select">
                                <option value="Regular">Regular</option>
                                <option value="Part-time">Part-time</option>
                                <option value="Distance">Distance</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Admission Type</label>
                            <select id="edit-admission-type" class="form-select">
                                <option value="Merit">Merit</option>
                                <option value="Management">Management</option>
                                <option value="Reservation">Reservation</option>
                                <option value="Lateral Entry">Lateral Entry</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Batch</label>
                            <input type="text" id="edit-batch" class="form-input" placeholder="e.g., 2023-2026">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Expected Completion Year</label>
                            <input type="text" id="edit-completion" class="form-input" placeholder="e.g., 2026">
                        </div>
                    </div>

                    <!-- Institution Identifiers Section -->
                    <h4
                        style="margin-bottom: var(--space-3); color: var(--grey-700); border-bottom: 2px solid var(--grey-200); padding-bottom: var(--space-2);">
                        üÜî Institution Identifiers</h4>
                    <div class="grid"
                        style="grid-template-columns: 1fr 1fr; gap: var(--space-4); margin-bottom: var(--space-6);">
                        <div class="form-group">
                            <label class="form-label">College Admission Number</label>
                            <input type="text" id="edit-admission-no" class="form-input" placeholder="Admission No">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Polytechnic Register Number</label>
                            <input type="text" id="edit-register-no" class="form-input" placeholder="Register No">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Exam Registration Number</label>
                            <input type="text" id="edit-exam-no" class="form-input" placeholder="Exam Reg No">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Roll Number</label>
                            <input type="text" id="edit-roll-no" class="form-input" placeholder="Roll No">
                        </div>
                    </div>

                    <!-- Status Section -->
                    <h4
                        style="margin-bottom: var(--space-3); color: var(--grey-700); border-bottom: 2px solid var(--grey-200); padding-bottom: var(--space-2);">
                        üìä Academic Status</h4>
                    <div class="form-group" style="margin-bottom: var(--space-4);">
                        <label class="form-label">Student Status *</label>
                        <div class="grid grid-4" style="gap: var(--space-3);">
                            <label
                                style="display: flex; align-items: center; gap: var(--space-2); padding: var(--space-3); border: 2px solid var(--success); border-radius: var(--radius); cursor: pointer; background: var(--success-light);">
                                <input type="radio" name="status" value="Active"> ‚úì Active
                            </label>
                            <label
                                style="display: flex; align-items: center; gap: var(--space-2); padding: var(--space-3); border: 2px solid var(--info); border-radius: var(--radius); cursor: pointer; background: var(--info-light);">
                                <input type="radio" name="status" value="Graduated"> üéì Graduated
                            </label>
                            <label
                                style="display: flex; align-items: center; gap: var(--space-2); padding: var(--space-3); border: 2px solid var(--warning); border-radius: var(--radius); cursor: pointer; background: var(--warning-light);">
                                <input type="radio" name="status" value="Transferred"> ‚Üó Transferred
                            </label>
                            <label
                                style="display: flex; align-items: center; gap: var(--space-2); padding: var(--space-3); border: 2px solid var(--danger); border-radius: var(--radius); cursor: pointer; background: var(--danger-light);">
                                <input type="radio" name="status" value="Discontinued"> ‚úï Discontinued
                            </label>
                        </div>
                    </div>

                    <div class="modal-footer"
                        style="padding: var(--space-4) 0 0; border: 0; margin-top: var(--space-4); display: flex; justify-content: space-between;">
                        <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary btn-lg">üíæ Save All Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- View History Modal -->
    <div class="modal-overlay" id="history-modal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title">Academic History</h3>
                <button class="modal-close" onclick="closeHistoryModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div
                    style="background: var(--grey-100); padding: var(--space-3); border-radius: var(--radius); margin-bottom: var(--space-4);">
                    <strong id="history-name">-</strong> (<span id="history-usn">-</span>)
                </div>
                <div class="timeline" id="history-timeline">
                    <!-- Timeline items will be inserted here -->
                </div>
            </div>
        </div>
    </div>

    <script src="../js/theme.js"></script>
    <script src="../js/toast.js"></script>
    <script src="../js/data.js"></script>
    <script>
        let allStudents = [];

        // Check authentication
        function checkAuth() {
            if (sessionStorage.getItem('usdi_admin_logged_in') !== 'true') {
                window.location.href = 'login.html';
                return;
            }
            loadDashboard();
        }

        function loadDashboard() {
            // Load institution name
            const institution = USDI_DATA.getInstitution();
            document.getElementById('institution-name').textContent = institution.name;

            // Load stats
            const stats = USDI_DATA.getStats();
            document.getElementById('stat-total').textContent = stats.total;
            document.getElementById('stat-active').textContent = stats.active;
            document.getElementById('stat-graduated').textContent = stats.graduated;
            document.getElementById('stat-other').textContent = stats.transferred + stats.discontinued;

            // Load pending verifications (show all for demo, in production filter by institution)
            loadPendingStudents();

            // Load verified students (with USN)
            allStudents = USDI_DATA.getAllStudents().filter(s => s.usn !== null);
            renderStudentsTable(allStudents);

            // Preview USN for new student
            document.getElementById('preview-usn').textContent = USDI_DATA.generateUSN();
        }

        function loadPendingStudents(institutionName = null) {
            const pending = USDI_DATA.getPendingInstitutionStudents(institutionName);
            const tbody = document.getElementById('pending-table');
            const countBadge = document.getElementById('pending-count');

            countBadge.textContent = pending.length;

            if (pending.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: var(--space-6); color: var(--grey-500);">
                            ‚úì No pending verifications
                        </td>
                    </tr>
                `;
                document.getElementById('pending-section').style.display = 'none';
                return;
            }

            document.getElementById('pending-section').style.display = 'block';

            tbody.innerHTML = pending.map(student => `
                <tr>
                    <td><strong>${student.fullName}</strong></td>
                    <td>${student.mobile}</td>
                    <td>${student.course || '-'}</td>
                    <td>${student.createdAt || '-'}</td>
                    <td>
                        <button class="btn btn-sm" style="background: #059669; color: #fff;" onclick="approveStudent('${student.mobile}')">
                            ‚úì Verify
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="rejectStudent('${student.mobile}')">
                            ‚úï Reject
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function approveStudent(mobile) {
            if (!confirm('Verify this student and generate their USDI number?')) return;

            console.log('Approving student with mobile:', mobile);
            const result = USDI_DATA.approveByInstitution(mobile);
            console.log('Approval result:', result);

            if (result && result.usn) {
                alert(`Student verified! USN assigned: ${result.usn}`);
                // Force full page reload to ensure fresh data
                location.reload();
            } else if (result && result.error) {
                alert('Error: ' + result.error);
            } else {
                console.error('Approval failed, result:', result);
                alert('Failed to verify student');
            }
        }

        function rejectStudent(mobile) {
            const reason = prompt('Enter rejection reason:');
            if (!reason) return;

            const result = USDI_DATA.rejectStudent(mobile, reason, 'Institution');

            if (result) {
                showWarning('Student application rejected');
                loadDashboard();
            } else {
                showError('Failed to reject student');
            }
        }

        function renderStudentsTable(students) {
            const tbody = document.getElementById('students-table');

            if (students.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: var(--space-8); color: var(--grey-500);">
                            No students found
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = students.map(student => `
                <tr>
                    <td><strong>${student.usn}</strong></td>
                    <td>${student.fullName}</td>
                    <td>${student.course}</td>
                    <td>${student.semesterYear}</td>
                    <td>${getStatusBadge(student.status)}</td>
                    <td>
                        <button class="btn btn-sm btn-secondary" onclick="openEditModal('${student.usn}')">Edit</button>
                        <button class="btn btn-sm btn-outline" onclick="viewHistory('${student.usn}')">History</button>
                    </td>
                </tr>
            `).join('');
        }

        function getStatusBadge(status) {
            let cls = 'info';
            if (status === 'Active') cls = 'success';
            if (status === 'Graduated') cls = 'info';
            if (status === 'Transferred' || status === 'Discontinued') cls = 'danger';
            if (status === 'Pending Verification' || status === 'Pending') cls = 'warning';

            return `<span class="badge badge-${cls}">${status}</span>`;
        }

        function filterStudents() {
            const query = document.getElementById('search-input').value.toLowerCase();
            const filtered = allStudents.filter(s =>
                s.fullName.toLowerCase().includes(query) ||
                s.usn.toLowerCase().includes(query)
            );
            renderStudentsTable(filtered);
        }

        // Export to CSV Function
        function exportToCSV() {
            if (allStudents.length === 0) {
                showWarning('No students to export');
                return;
            }

            // Define CSV headers
            const headers = ['USN', 'Full Name', 'Date of Birth', 'Mobile', 'Course', 'Semester/Year', 'Status', 'Institution'];

            // Convert students to CSV rows
            const rows = allStudents.map(student => [
                student.usn,
                student.fullName,
                student.dob || '',
                student.mobile || '',
                student.course || '',
                student.semesterYear || '',
                student.status || '',
                student.institution || ''
            ]);

            // Build CSV content
            let csvContent = headers.join(',') + '\n';
            rows.forEach(row => {
                csvContent += row.map(cell => {
                    // Escape double quotes and wrap in quotes if contains comma
                    const escaped = String(cell).replace(/"/g, '""');
                    return escaped.includes(',') ? `"${escaped}"` : escaped;
                }).join(',') + '\n';
            });

            // Create and download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `students_export_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showSuccess(`Exported ${allStudents.length} students to CSV!`);
        }

        // Add Student Modal
        function openAddModal() {
            document.getElementById('add-form').reset();
            document.getElementById('preview-usn').textContent = USDI_DATA.generateUSN();
            document.getElementById('add-modal').classList.add('active');
        }

        function closeAddModal() {
            document.getElementById('add-modal').classList.remove('active');
        }

        function handleAddStudent(e) {
            e.preventDefault();

            const institution = USDI_DATA.getInstitution();
            const newStudent = {
                fullName: document.getElementById('add-name').value.trim(),
                dob: document.getElementById('add-dob').value,
                mobile: document.getElementById('add-mobile').value.trim(),
                institution: institution.name,
                course: document.getElementById('add-course').value,
                semesterYear: document.getElementById('add-semester').value,
                status: 'Active',
                photo: null
            };

            // Validate mobile
            if (!/^\d{10}$/.test(newStudent.mobile)) {
                showError('Please enter a valid 10-digit mobile number');
                return;
            }

            // Check if mobile already exists
            if (USDI_DATA.getStudentByMobile(newStudent.mobile)) {
                showError('A student with this mobile number already exists');
                return;
            }

            const added = USDI_DATA.addStudent(newStudent);
            showSuccess(`Student added successfully! USN: ${added.usn}`);
            closeAddModal();
            loadDashboard();
        }

        // Edit Student Modal
        function openEditModal(usn) {
            const student = USDI_DATA.getStudentByUSN(usn);
            if (!student) return;

            // Basic info
            document.getElementById('edit-usn').value = student.usn;
            document.getElementById('edit-usn-display').textContent = student.usn;
            document.getElementById('edit-name-display').textContent = student.fullName;

            // Personal Details
            document.getElementById('edit-fullname').value = student.fullName || '';
            document.getElementById('edit-dob').value = student.dob || '';
            document.getElementById('edit-gender').value = student.gender || 'Male';
            document.getElementById('edit-mobile').value = student.mobile || '';
            document.getElementById('edit-email').value = student.email || '';
            document.getElementById('edit-category').value = student.category || 'General';

            // Institution Details
            document.getElementById('edit-institution').value = student.institution || '';
            document.getElementById('edit-inst-type').value = student.institutionType || 'Government Polytechnic';
            document.getElementById('edit-authority').value = student.affiliatedAuthority || '';
            document.getElementById('edit-course').value = student.course || '';
            document.getElementById('edit-branch').value = student.branchCode || '';
            document.getElementById('edit-semester').value = student.semesterYear || '';
            document.getElementById('edit-mode').value = student.modeOfStudy || 'Regular';
            document.getElementById('edit-admission-type').value = student.admissionType || 'Merit';
            document.getElementById('edit-batch').value = student.batch || '';
            document.getElementById('edit-completion').value = student.expectedCompletionYear || '';

            // Institution Identifiers
            const identifiers = student.institutionIdentifiers || {};
            document.getElementById('edit-admission-no').value = identifiers.collegeAdmissionNumber || student.admissionNumber || '';
            document.getElementById('edit-register-no').value = identifiers.polytechnicRegisterNumber || student.polytechnicRegisterNumber || '';
            document.getElementById('edit-exam-no').value = identifiers.examRegistrationNumber || student.examRegistrationNumber || '';
            document.getElementById('edit-roll-no').value = identifiers.rollNumber || student.rollNumber || '';

            // Set status radio
            const statusRadios = document.querySelectorAll('input[name="status"]');
            statusRadios.forEach(radio => {
                radio.checked = radio.value === student.status;
            });

            document.getElementById('edit-modal').classList.add('active');
        }

        function closeEditModal() {
            document.getElementById('edit-modal').classList.remove('active');
        }

        function handleEditStudent(e) {
            e.preventDefault();

            const usn = document.getElementById('edit-usn').value;
            const selectedStatus = document.querySelector('input[name="status"]:checked');

            const updates = {
                // Personal Details
                fullName: document.getElementById('edit-fullname').value.trim(),
                dob: document.getElementById('edit-dob').value,
                gender: document.getElementById('edit-gender').value,
                mobile: document.getElementById('edit-mobile').value.trim(),
                email: document.getElementById('edit-email').value.trim(),
                category: document.getElementById('edit-category').value,

                // Institution Details
                institution: document.getElementById('edit-institution').value.trim(),
                institutionType: document.getElementById('edit-inst-type').value,
                affiliatedAuthority: document.getElementById('edit-authority').value.trim(),
                course: document.getElementById('edit-course').value,
                branchCode: document.getElementById('edit-branch').value.trim(),
                semesterYear: document.getElementById('edit-semester').value,
                modeOfStudy: document.getElementById('edit-mode').value,
                admissionType: document.getElementById('edit-admission-type').value,
                batch: document.getElementById('edit-batch').value.trim(),
                expectedCompletionYear: document.getElementById('edit-completion').value.trim(),

                // Institution Identifiers
                institutionIdentifiers: {
                    collegeAdmissionNumber: document.getElementById('edit-admission-no').value.trim(),
                    polytechnicRegisterNumber: document.getElementById('edit-register-no').value.trim(),
                    examRegistrationNumber: document.getElementById('edit-exam-no').value.trim(),
                    rollNumber: document.getElementById('edit-roll-no').value.trim()
                },

                // Status
                status: selectedStatus ? selectedStatus.value : 'Active'
            };

            USDI_DATA.updateStudent(usn, updates);
            showSuccess('Student record updated successfully!');
            closeEditModal();
            loadDashboard();
        }


        // History Modal
        function viewHistory(usn) {
            const student = USDI_DATA.getStudentByUSN(usn);
            if (!student) return;

            document.getElementById('history-name').textContent = student.fullName;
            document.getElementById('history-usn').textContent = student.usn;

            const timeline = document.getElementById('history-timeline');
            timeline.innerHTML = student.academicHistory.map(item => `
                <div class="timeline-item">
                    <div class="timeline-date">${formatDate(item.date)}</div>
                    <div class="timeline-content">${item.event}</div>
                </div>
            `).join('');

            document.getElementById('history-modal').classList.add('active');
        }

        function closeHistoryModal() {
            document.getElementById('history-modal').classList.remove('active');
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-IN', { day: 'numeric', month: 'short', year: 'numeric' });
        }

        function logout() {
            sessionStorage.removeItem('usdi_admin_logged_in');
            sessionStorage.removeItem('usdi_admin_user');
            window.location.href = 'login.html';
        }

        // Close modals on outside click
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal-overlay')) {
                    overlay.classList.remove('active');
                }
            });
        });

        // Initialize
        checkAuth();

        function toggleMobileMenu() {
            document.querySelector('.nav').classList.toggle('open');
            document.querySelector('.menu-toggle').classList.toggle('active');

            let overlay = document.querySelector('.mobile-overlay');
            if (!overlay) {
                overlay = document.createElement('div');
                overlay.className = 'mobile-overlay';
                overlay.onclick = toggleMobileMenu;
                document.body.appendChild(overlay);
            }
            overlay.classList.toggle('active');
        }
    </script>
    <script src="../js/translations.js"></script>
    <script src="../js/language.js"></script>
    <!-- External Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

    <!-- Chatbot Container (Hidden by default) -->
    <div class="chatbot-container" id="chatbot-container">
        <!-- ... existing chatbot HTML ... -->
        <div class="chatbot-header">
            <h3>USDI Assistant</h3>
            <button class="close-chat" onclick="toggleChatbot()">√ó</button>
        </div>
        <div class="chatbot-body" id="chatbot-body">
            <div class="message bot">
                Hello! How can I help you today?
            </div>
        </div>
        <div class="chatbot-input">
            <input type="text" id="chat-input" placeholder="Type a message...">
            <button onclick="sendMessage()">Send</button>
        </div>
    </div>

    <!-- NEW ANIMATED CHAT BUTTON -->
    <button class="generate-button" onclick="toggleChatbot()" aria-label="Open Chat Assistant">
        <svg class="icon" viewBox="0 0 24 26">
            <path
                d="M5.16515 2.62145L5.8075 0.999247C5.83876 0.919722 5.9154 0.866699 6.00112 0.866699C6.08683 0.866699 6.16347 0.919722 6.19473 0.999247L6.83708 2.62145L8.44145 3.27094C8.5201 3.30254 8.57254 3.38003 8.57254 3.4667C8.57254 3.55337 8.5201 3.63085 8.44145 3.66246L6.83708 4.31195L6.19473 5.93415C6.16347 6.0147 6.08683 6.0667 6.00112 6.0667C5.9154 6.0667 5.83876 6.0147 5.8075 5.93415L5.16515 4.31195L3.56078 3.66246C3.48112 3.63085 3.42969 3.55337 3.42969 3.4667C3.42969 3.38003 3.48112 3.30254 3.56078 3.27094L5.16515 2.62145Z" />
            <path
                d="M11.2362 9.43967C11.5502 9.30067 11.8015 9.05025 11.9405 8.73617L13.5494 5.11725C13.7169 4.74204 14.0887 4.5 14.5 4.5C14.9112 4.5 15.2839 4.74204 15.4506 5.11725L17.0603 8.73617C17.1985 9.05025 17.4497 9.3015 17.7638 9.43967L21.3827 11.0494C21.7579 11.2161 22 11.5887 22 12C22 12.4112 21.7579 12.7831 21.3827 12.9506L17.7638 14.5595C17.4497 14.6985 17.1993 14.9497 17.0603 15.2638L15.4506 18.8827C15.2839 19.2579 14.9112 19.5 14.5 19.5C14.0887 19.5 13.7169 19.2579 13.5494 18.8827L11.9405 15.2638C11.8015 14.9497 11.5502 14.6985 11.2362 14.5595L7.61725 12.9506C7.24204 12.7831 7 12.4112 7 12C7 11.5887 7.24204 11.2161 7.61725 11.0494L11.2362 9.43967Z" />
            <path
                d="M4.60728 19.392L5.67703 16.6875C5.72997 16.5541 5.85854 16.4666 6.00056 16.4666C6.14258 16.4666 6.27031 16.5541 6.32325 16.6875L7.39299 19.392L10.0678 20.4736C10.1997 20.5271 10.2863 20.6563 10.2863 20.7999C10.2863 20.9435 10.1997 21.0735 10.0678 21.1271L7.39299 22.2087L6.32325 24.9123C6.27031 25.0457 6.14258 25.1332 6.00056 25.1332C5.85854 25.1332 5.72997 25.0457 5.67703 24.9123L4.60728 22.2087L1.93333 21.1271C1.8014 21.0735 1.71484 20.9435 1.71484 20.7999C1.71484 20.6563 1.8014 20.5271 1.93333 20.4736L4.60728 19.392Z" />
        </svg>
        <span>Chat with AI</span>
    </button>
    <script src="../js/chatbot.js"></script>
    <script src="../js/button-anim.js"></script>
</body>

</html>