<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="USDI Institution Dashboard - Manage Student Records">
    <title>Institution Dashboard - USDI</title>
    <link rel="stylesheet" href="../css/styles.css">
</head>

<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <a href="../index.html" class="logo">
                <div class="logo-icon">üéì</div>
                <span>USDI</span>
            </a>
            <nav class="nav">
                <a href="dashboard.html" class="active">Dashboard</a>
                <a href="#" onclick="logout()">Logout</a>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main class="dashboard">
        <div class="container">
            <!-- Header -->
            <div class="dashboard-header flex justify-between items-center">
                <div>
                    <h1 class="dashboard-title">Institution Dashboard</h1>
                    <p class="dashboard-subtitle" id="institution-name">National Institute of Technology</p>
                </div>
                <button class="btn btn-primary" onclick="openAddModal()">
                    + Add New Student
                </button>
            </div>

            <!-- Stats Cards -->
            <div class="grid grid-4 mb-8" id="stats-cards">
                <div class="stat-card">
                    <div class="stat-value" id="stat-total">0</div>
                    <div class="stat-label">Total Students</div>
                </div>
                <div class="stat-card success">
                    <div class="stat-value" id="stat-active">0</div>
                    <div class="stat-label">Active</div>
                </div>
                <div class="stat-card info">
                    <div class="stat-value" id="stat-graduated">0</div>
                    <div class="stat-label">Graduated</div>
                </div>
                <div class="stat-card warning">
                    <div class="stat-value" id="stat-other">0</div>
                    <div class="stat-label">Transferred/Discontinued</div>
                </div>
            </div>

            <!-- Student List -->
            <div class="card">
                <div class="card-header flex justify-between items-center">
                    <h3 style="margin: 0;">Student Records</h3>
                    <div class="search-box" style="width: 300px;">
                        <span class="search-icon">üîç</span>
                        <input type="text" id="search-input" class="form-input" placeholder="Search by name or USN..."
                            oninput="filterStudents()">
                    </div>
                </div>
                <div class="card-body" style="padding: 0;">
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>USN</th>
                                    <th>Name</th>
                                    <th>Course</th>
                                    <th>Semester/Year</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="students-table">
                                <!-- Student rows will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Add Student Modal -->
    <div class="modal-overlay" id="add-modal">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h3 class="modal-title">Add New Student</h3>
                <button class="modal-close" onclick="closeAddModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div
                    style="background: var(--info-light); color: var(--info); padding: var(--space-3); border-radius: var(--radius); margin-bottom: var(--space-4);">
                    <strong>USN will be auto-generated:</strong> <span id="preview-usn">USDI2026XXX</span>
                </div>
                <form id="add-form" onsubmit="handleAddStudent(event)">
                    <div class="grid" style="grid-template-columns: 1fr 1fr; gap: var(--space-4);">
                        <div class="form-group">
                            <label class="form-label">Full Name *</label>
                            <input type="text" id="add-name" class="form-input" placeholder="Enter full name" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Date of Birth *</label>
                            <input type="date" id="add-dob" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Mobile Number *</label>
                            <input type="tel" id="add-mobile" class="form-input" placeholder="10-digit mobile"
                                maxlength="10" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Course *</label>
                            <select id="add-course" class="form-select" required>
                                <option value="">Select Course</option>
                                <option value="B.Tech Computer Science">B.Tech Computer Science</option>
                                <option value="B.Tech Electronics">B.Tech Electronics</option>
                                <option value="B.Tech Mechanical">B.Tech Mechanical</option>
                                <option value="B.Tech Civil">B.Tech Civil</option>
                                <option value="B.Tech Information Technology">B.Tech Information Technology</option>
                                <option value="B.Tech Electrical">B.Tech Electrical</option>
                                <option value="MBA">MBA</option>
                                <option value="MCA">MCA</option>
                            </select>
                        </div>
                        <div class="form-group" style="grid-column: span 2;">
                            <label class="form-label">Semester/Year *</label>
                            <select id="add-semester" class="form-select" required>
                                <option value="">Select Semester</option>
                                <option value="1st Semester">1st Semester</option>
                                <option value="2nd Semester">2nd Semester</option>
                                <option value="3rd Semester">3rd Semester</option>
                                <option value="4th Semester">4th Semester</option>
                                <option value="5th Semester">5th Semester</option>
                                <option value="6th Semester">6th Semester</option>
                                <option value="7th Semester">7th Semester</option>
                                <option value="8th Semester">8th Semester</option>
                                <option value="1st Year">1st Year</option>
                                <option value="2nd Year">2nd Year</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer"
                        style="padding: var(--space-4) 0 0; border: 0; margin-top: var(--space-4);">
                        <button type="button" class="btn btn-secondary" onclick="closeAddModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Add Student</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Student Modal -->
    <div class="modal-overlay" id="edit-modal">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h3 class="modal-title">Edit Student</h3>
                <button class="modal-close" onclick="closeEditModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div
                    style="background: var(--grey-100); padding: var(--space-3); border-radius: var(--radius); margin-bottom: var(--space-4);">
                    <strong>USN:</strong> <span id="edit-usn-display">-</span> |
                    <strong>Name:</strong> <span id="edit-name-display">-</span>
                </div>
                <form id="edit-form" onsubmit="handleEditStudent(event)">
                    <input type="hidden" id="edit-usn">
                    <div class="grid" style="grid-template-columns: 1fr 1fr; gap: var(--space-4);">
                        <div class="form-group">
                            <label class="form-label">Course</label>
                            <select id="edit-course" class="form-select">
                                <option value="B.Tech Computer Science">B.Tech Computer Science</option>
                                <option value="B.Tech Electronics">B.Tech Electronics</option>
                                <option value="B.Tech Mechanical">B.Tech Mechanical</option>
                                <option value="B.Tech Civil">B.Tech Civil</option>
                                <option value="B.Tech Information Technology">B.Tech Information Technology</option>
                                <option value="B.Tech Electrical">B.Tech Electrical</option>
                                <option value="MBA">MBA</option>
                                <option value="MCA">MCA</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Semester/Year</label>
                            <select id="edit-semester" class="form-select">
                                <option value="1st Semester">1st Semester</option>
                                <option value="2nd Semester">2nd Semester</option>
                                <option value="3rd Semester">3rd Semester</option>
                                <option value="4th Semester">4th Semester</option>
                                <option value="5th Semester">5th Semester</option>
                                <option value="6th Semester">6th Semester</option>
                                <option value="7th Semester">7th Semester</option>
                                <option value="8th Semester">8th Semester</option>
                                <option value="Completed">Completed</option>
                            </select>
                        </div>
                        <div class="form-group" style="grid-column: span 2;">
                            <label class="form-label">Student Status</label>
                            <div class="grid grid-4" style="gap: var(--space-3);">
                                <label
                                    style="display: flex; align-items: center; gap: var(--space-2); padding: var(--space-3); border: 2px solid var(--grey-200); border-radius: var(--radius); cursor: pointer;">
                                    <input type="radio" name="status" value="Active"> Active
                                </label>
                                <label
                                    style="display: flex; align-items: center; gap: var(--space-2); padding: var(--space-3); border: 2px solid var(--grey-200); border-radius: var(--radius); cursor: pointer;">
                                    <input type="radio" name="status" value="Graduated"> Graduated
                                </label>
                                <label
                                    style="display: flex; align-items: center; gap: var(--space-2); padding: var(--space-3); border: 2px solid var(--grey-200); border-radius: var(--radius); cursor: pointer;">
                                    <input type="radio" name="status" value="Transferred"> Transferred
                                </label>
                                <label
                                    style="display: flex; align-items: center; gap: var(--space-2); padding: var(--space-3); border: 2px solid var(--grey-200); border-radius: var(--radius); cursor: pointer;">
                                    <input type="radio" name="status" value="Discontinued"> Discontinued
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer"
                        style="padding: var(--space-4) 0 0; border: 0; margin-top: var(--space-4);">
                        <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- View History Modal -->
    <div class="modal-overlay" id="history-modal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title">Academic History</h3>
                <button class="modal-close" onclick="closeHistoryModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div
                    style="background: var(--grey-100); padding: var(--space-3); border-radius: var(--radius); margin-bottom: var(--space-4);">
                    <strong id="history-name">-</strong> (<span id="history-usn">-</span>)
                </div>
                <div class="timeline" id="history-timeline">
                    <!-- Timeline items will be inserted here -->
                </div>
            </div>
        </div>
    </div>

    <script src="../js/data.js"></script>
    <script>
        let allStudents = [];

        // Check authentication
        function checkAuth() {
            if (sessionStorage.getItem('usdi_admin_logged_in') !== 'true') {
                window.location.href = 'login.html';
                return;
            }
            loadDashboard();
        }

        function loadDashboard() {
            // Load institution name
            const institution = USDI_DATA.getInstitution();
            document.getElementById('institution-name').textContent = institution.name;

            // Load stats
            const stats = USDI_DATA.getStats();
            document.getElementById('stat-total').textContent = stats.total;
            document.getElementById('stat-active').textContent = stats.active;
            document.getElementById('stat-graduated').textContent = stats.graduated;
            document.getElementById('stat-other').textContent = stats.transferred + stats.discontinued;

            // Load students
            allStudents = USDI_DATA.getAllStudents();
            renderStudentsTable(allStudents);

            // Preview USN for new student
            document.getElementById('preview-usn').textContent = USDI_DATA.generateUSN();
        }

        function renderStudentsTable(students) {
            const tbody = document.getElementById('students-table');

            if (students.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: var(--space-8); color: var(--grey-500);">
                            No students found
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = students.map(student => `
                <tr>
                    <td><strong>${student.usn}</strong></td>
                    <td>${student.fullName}</td>
                    <td>${student.course}</td>
                    <td>${student.semesterYear}</td>
                    <td><span class="badge badge-${student.status.toLowerCase()}">${student.status}</span></td>
                    <td>
                        <button class="btn btn-sm btn-secondary" onclick="openEditModal('${student.usn}')">Edit</button>
                        <button class="btn btn-sm btn-outline" onclick="viewHistory('${student.usn}')">History</button>
                    </td>
                </tr>
            `).join('');
        }

        function filterStudents() {
            const query = document.getElementById('search-input').value.toLowerCase();
            const filtered = allStudents.filter(s =>
                s.fullName.toLowerCase().includes(query) ||
                s.usn.toLowerCase().includes(query)
            );
            renderStudentsTable(filtered);
        }

        // Add Student Modal
        function openAddModal() {
            document.getElementById('add-form').reset();
            document.getElementById('preview-usn').textContent = USDI_DATA.generateUSN();
            document.getElementById('add-modal').classList.add('active');
        }

        function closeAddModal() {
            document.getElementById('add-modal').classList.remove('active');
        }

        function handleAddStudent(e) {
            e.preventDefault();

            const institution = USDI_DATA.getInstitution();
            const newStudent = {
                fullName: document.getElementById('add-name').value.trim(),
                dob: document.getElementById('add-dob').value,
                mobile: document.getElementById('add-mobile').value.trim(),
                institution: institution.name,
                course: document.getElementById('add-course').value,
                semesterYear: document.getElementById('add-semester').value,
                status: 'Active',
                photo: null
            };

            // Validate mobile
            if (!/^\d{10}$/.test(newStudent.mobile)) {
                alert('Please enter a valid 10-digit mobile number');
                return;
            }

            // Check if mobile already exists
            if (USDI_DATA.getStudentByMobile(newStudent.mobile)) {
                alert('A student with this mobile number already exists');
                return;
            }

            const added = USDI_DATA.addStudent(newStudent);
            alert(`Student added successfully!\nUSN: ${added.usn}`);
            closeAddModal();
            loadDashboard();
        }

        // Edit Student Modal
        function openEditModal(usn) {
            const student = USDI_DATA.getStudentByUSN(usn);
            if (!student) return;

            document.getElementById('edit-usn').value = student.usn;
            document.getElementById('edit-usn-display').textContent = student.usn;
            document.getElementById('edit-name-display').textContent = student.fullName;
            document.getElementById('edit-course').value = student.course;
            document.getElementById('edit-semester').value = student.semesterYear;

            // Set status radio
            const statusRadios = document.querySelectorAll('input[name="status"]');
            statusRadios.forEach(radio => {
                radio.checked = radio.value === student.status;
            });

            document.getElementById('edit-modal').classList.add('active');
        }

        function closeEditModal() {
            document.getElementById('edit-modal').classList.remove('active');
        }

        function handleEditStudent(e) {
            e.preventDefault();

            const usn = document.getElementById('edit-usn').value;
            const selectedStatus = document.querySelector('input[name="status"]:checked');

            const updates = {
                course: document.getElementById('edit-course').value,
                semesterYear: document.getElementById('edit-semester').value,
                status: selectedStatus ? selectedStatus.value : 'Active'
            };

            USDI_DATA.updateStudent(usn, updates);
            alert('Student record updated successfully!');
            closeEditModal();
            loadDashboard();
        }

        // History Modal
        function viewHistory(usn) {
            const student = USDI_DATA.getStudentByUSN(usn);
            if (!student) return;

            document.getElementById('history-name').textContent = student.fullName;
            document.getElementById('history-usn').textContent = student.usn;

            const timeline = document.getElementById('history-timeline');
            timeline.innerHTML = student.academicHistory.map(item => `
                <div class="timeline-item">
                    <div class="timeline-date">${formatDate(item.date)}</div>
                    <div class="timeline-content">${item.event}</div>
                </div>
            `).join('');

            document.getElementById('history-modal').classList.add('active');
        }

        function closeHistoryModal() {
            document.getElementById('history-modal').classList.remove('active');
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-IN', { day: 'numeric', month: 'short', year: 'numeric' });
        }

        function logout() {
            sessionStorage.removeItem('usdi_admin_logged_in');
            sessionStorage.removeItem('usdi_admin_user');
            window.location.href = 'login.html';
        }

        // Close modals on outside click
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal-overlay')) {
                    overlay.classList.remove('active');
                }
            });
        });

        // Initialize
        checkAuth();
    </script>
</body>

</html>