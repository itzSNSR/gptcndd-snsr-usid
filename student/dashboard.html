<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="USDI Student Dashboard - View your digital student ID">
    <title>Student Dashboard - USDI</title>
    <link rel="stylesheet" href="../css/styles.css">
    <script src="../js/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>
    <style>
        .section-card {
            background: var(--white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            margin-bottom: var(--space-6);
            overflow: hidden;
        }

        .section-card-header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: var(--space-4) var(--space-6);
            font-weight: 600;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .section-card-body {
            padding: var(--space-6);
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--space-5);
        }

        .detail-grid.three-col {
            grid-template-columns: repeat(3, 1fr);
        }

        .detail-item {
            padding: var(--space-3);
            background: var(--grey-50);
            border-radius: var(--radius);
            border-left: 3px solid var(--primary);
        }

        .detail-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            color: var(--grey-500);
            margin-bottom: var(--space-1);
            font-weight: 600;
        }

        .detail-value {
            font-weight: 600;
            color: var(--grey-800);
            font-size: 0.95rem;
        }

        .detail-item.full-width {
            grid-column: span 2;
        }

        .academic-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .academic-table th {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: var(--space-3) var(--space-4);
            text-align: left;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.5px;
        }

        .academic-table td {
            padding: var(--space-3) var(--space-4);
            border-bottom: 1px solid var(--grey-200);
        }

        .academic-table tr:nth-child(even) {
            background: var(--grey-50);
        }

        .academic-table tr:hover {
            background: var(--primary-light);
        }

        .status-pill {
            display: inline-block;
            padding: var(--space-1) var(--space-3);
            border-radius: 50px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-completed {
            background: var(--success-light);
            color: var(--success);
        }

        .status-ongoing {
            background: var(--primary-light);
            color: var(--primary);
        }

        .verification-badge {
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            background: linear-gradient(135deg, var(--success), #059669);
            color: white;
            padding: var(--space-2) var(--space-4);
            border-radius: 50px;
            font-weight: 600;
            font-size: 0.85rem;
        }

        .method-tag {
            display: inline-block;
            background: var(--grey-100);
            padding: var(--space-1) var(--space-3);
            border-radius: var(--radius);
            font-size: 0.8rem;
            margin-right: var(--space-2);
            margin-bottom: var(--space-2);
        }

        .govt-note {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border-left: 4px solid #f59e0b;
            padding: var(--space-4);
            border-radius: var(--radius);
            margin-top: var(--space-4);
        }

        .govt-note p {
            margin: 0;
            color: #92400e;
            font-size: 0.85rem;
        }

        .two-column-layout {
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: var(--space-8);
            align-items: start;
        }

        @media (max-width: 1024px) {
            .two-column-layout {
                grid-template-columns: 1fr;
            }

            .detail-grid {
                grid-template-columns: 1fr;
            }

            .detail-grid.three-col {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>

<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <nav class="navbar"
                style="display: flex; align-items: center; justify-content: space-between; padding: 10px 0;">
                <div style="display: flex; align-items: center;">
                    <a href="javascript:history.back()" class="btn-back" aria-label="Go Back">‚Üê</a>
                    <a href="../index.html" class="logo"
                        style="display: flex; align-items: center; gap: 10px; text-decoration: none; color: inherit;">
                        <span class="logo-icon" style="font-size: 1.5rem;">üéì</span>
                        <span style="font-weight: bold; font-size: 1.2rem;">USDI</span>
                    </a>
                </div>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <a href="dashboard.html" class="active" data-i18n="lbl_my_profile"
                        style="text-decoration: none; color: var(--primary); font-weight: 500;">My ID</a>
                    <a href="#" onclick="logout()" data-i18n="btn_logout"
                        style="text-decoration: none; color: var(--grey-600);">Logout</a>
                    <div class="custom-dropdown" id="language-dropdown">
                        <div class="dropdown-trigger" onclick="toggleLanguageDropdown()">
                            <span class="selected-lang">üá∫üá∏ English</span>
                            <span class="dropdown-arrow">‚ñº</span>
                        </div>
                        <div class="dropdown-options">
                            <div class="dropdown-option" onclick="changeLanguage('en')">üá∫üá∏ English</div>
                            <div class="dropdown-option" onclick="changeLanguage('ml')">üáÆüá≥ ‡¥Æ‡¥≤‡¥Ø‡¥æ‡¥≥‡¥Ç</div>
                            <div class="dropdown-option" onclick="changeLanguage('hi')">üáÆüá≥ ‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</div>
                        </div>
                    </div>
                    <button class="theme-toggle" onclick="toggleTheme()" title="Toggle Theme">
                        <span class="theme-icon moon">üåô</span>
                        <span class="theme-icon sun">‚òÄÔ∏è</span>
                    </button>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main class="dashboard">
        <div class="container">
            <!-- Welcome Header -->
            <div class="dashboard-header">
                <h1 class="dashboard-title">Welcome, <span id="student-name">Student</span></h1>
                <p class="dashboard-subtitle">Your official digital student identity</p>

                <!-- Verification Status Banner -->
                <div id="verification-banner" class="govt-note hidden"
                    style="background: linear-gradient(135deg, #fff3cd, #fff8e1); border-left-color: #ffc107;">
                    <h4 style="margin: 0 0 5px 0; color: #856404;">‚ö†Ô∏è Verification Pending</h4>
                    <p style="color: #856404;">Your account is currently under verification. Some features may be
                        limited until your Institute and Government verification is complete.</p>
                    <div style="margin-top: 10px; font-size: 0.85rem;">
                        <span id="status-inst" class="method-tag">Institute: Pending</span>
                        <span id="status-govt" class="method-tag">Government: Pending</span>
                    </div>
                </div>
            </div>

            <div class="two-column-layout">
                <div id="id-card-section">
                    <div class="section-header">
                        <h3 class="section-title" data-i18n="lbl_student_id_card">Digital Student ID</h3>
                    </div>

                    <!-- Pending Message (shown when no USN yet) -->
                    <div id="pending-id-message" class="hidden"
                        style="background: linear-gradient(135deg, #e0f2fe, #dbeafe); padding: 2rem; border-radius: 16px; text-align: center; margin-bottom: 1.5rem;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">‚è≥</div>
                        <h3 style="color: #1e40af; margin-bottom: 0.5rem;">ID Card Coming Soon!</h3>
                        <p style="color: #3b82f6; margin-bottom: 1rem;">Your Digital Student ID will be generated once
                            your verification is complete.</p>
                        <div style="background: #fff; padding: 1rem; border-radius: 8px; display: inline-block;">
                            <p style="margin: 0; color: #64748b; font-size: 0.9rem;">Current Status:</p>
                            <p id="pending-status-text" style="margin: 0.5rem 0 0 0; font-weight: 600; color: #f59e0b;">
                                Pending Institution Verification</p>
                        </div>
                    </div>

                    <!-- 3D ID Card -->
                    <div class="id-card-perspective" onclick="this.classList.toggle('flipped')">
                        <div class="id-card-inner">

                            <!-- Front Face -->
                            <div class="id-card-front">
                                <!-- Top Row -->
                                <div class="card-header-row">
                                    <div class="card-brand">
                                        <div class="card-logo-box">
                                            <span style="font-size: 1.2rem;">üõ°Ô∏è</span>
                                        </div>
                                        <div class="card-brand-text">
                                            <h4>Identity</h4>
                                            <h3>USDI Network</h3>
                                        </div>
                                    </div>
                                    <div class="card-status-badge" id="card-status">ACTIVE</div>
                                </div>

                                <!-- Middle Row (Profile) -->
                                <div class="card-profile-row">
                                    <div class="card-photo-box"
                                        onclick="event.stopPropagation(); document.getElementById('photo-input').click()"
                                        title="Click to upload photo">
                                        <!-- Photo Input (Hidden) -->
                                        <input type="file" id="photo-input" accept="image/*"
                                            onchange="handlePhotoUpload(event)" style="display: none;">

                                        <!-- Photo Display -->
                                        <img id="photo-image" src="" alt="Student Photo" class="card-photo-img"
                                            style="display: none;">
                                        <span id="photo-placeholder" class="card-photo-placeholder">üë§</span>
                                    </div>

                                    <div class="card-info">
                                        <h2 id="card-name">Student Name</h2>
                                        <p id="card-institution">University Name</p>
                                        <span class="card-role-chip" id="card-course">Role/Course</span>
                                    </div>
                                </div>

                                <!-- Bottom Row -->
                                <div class="card-footer-row">
                                    <div>
                                        <div class="card-label">ID Number</div>
                                        <div class="card-value" id="card-usn">USID-000-0000</div>
                                    </div>
                                    <div style="text-align: right;">
                                        <div class="card-label">DOB / Valid Thru</div>
                                        <div class="card-value" id="card-dob">01/01/2000</div>
                                    </div>
                                </div>

                                <!-- Hidden Semester for JS compatibility/future use -->
                                <div id="card-semester" style="display:none;"></div>
                            </div>

                            <!-- Back Face -->
                            <div class="id-card-back">
                                <div class="card-qr-box">
                                    <div id="qr-code"></div>
                                    <!-- QR Code Container (Note: JS targets 'qr-code' ID not 'qrcode') -->
                                </div>
                                <div class="card-security-text">Secure Digital Credential</div>
                                <div class="card-details-text">
                                    Verification ID: <span
                                        style="font-family: monospace; opacity: 0.7;">0x75736964</span><br>
                                    This card is cryptographically signed and verifiable by the USDI Network.
                                </div>
                            </div>

                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex gap-4 mt-6" style="flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="printIDCard()" style="background: #059669;">
                            üñ®Ô∏è Print ID Card
                        </button>
                        <button class="btn btn-primary" onclick="downloadPDF()" data-i18n="lbl_download_pdf">
                            üì• Download PDF
                        </button>
                        <button class="btn btn-secondary" onclick="shareLink()" data-i18n="lbl_share_link">
                            üîó Share Link
                        </button>
                        <button class="btn btn-outline" onclick="openEditRequestModal()"
                            style="border-color: #FFD700; color: #b8860b;" data-i18n="lbl_request_edit">
                            ‚úèÔ∏è Request Edit
                        </button>
                    </div>
                </div>

                <!-- Right Column: All Details -->
                <div>
                    <!-- SECTION 1: Personal Details -->
                    <div class="section-card">
                        <div class="section-card-header">
                            üë§ <span data-i18n="lbl_personal_details">Personal Details</span>
                        </div>
                        <div class="section-card-body">
                            <div class="detail-grid">
                                <div class="detail-item">
                                    <div class="detail-label" data-i18n="lbl_name">Full Name</div>
                                    <div class="detail-value" id="detail-name">-</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label" data-i18n="lbl_dob">Date of Birth</div>
                                    <div class="detail-value" id="detail-dob">-</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label" data-i18n="lbl_gender">Gender</div>
                                    <div class="detail-value" id="detail-gender">-</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label" data-i18n="lbl_mobile_no">Mobile Number</div>
                                    <div class="detail-value" id="detail-mobile">-</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label" data-i18n="lbl_email">Email ID</div>
                                    <div class="detail-value" id="detail-email">-</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label" data-i18n="lbl_usn">Unique Student ID (USDI)</div>
                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <div class="detail-value" id="detail-usn"
                                            style="color: var(--primary); font-weight: 700; margin-bottom: 0;">-</div>
                                        <button id="btn-copy-usid" onclick="copyUSN(this)" class="btn-copy"
                                            title="Copy USID"
                                            style="background: none; border: none; cursor: pointer; padding: 0.2rem; display: flex; align-items: center; color: var(--grey-600); transition: all 0.2s ease; transform: scale(1);">
                                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none"
                                                stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                                stroke-linejoin="round">
                                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1">
                                                </path>
                                            </svg>
                                        </button>
                                        <span id="copy-feedback"
                                            style="font-size: 0.8rem; color: #10b981; opacity: 0; transition: opacity 0.3s;">Copied!</span>
                                    </div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">Nationality</div>
                                    <div class="detail-value" id="detail-nationality">-</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">State / District</div>
                                    <div class="detail-value" id="detail-location">-</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- SECTION 2: Current Institution -->
                    <div class="section-card">
                        <div class="section-card-header">
                            üè´ <span data-i18n="lbl_institution">Current Institution</span>
                        </div>
                        <div class="section-card-body">
                            <div class="detail-grid">
                                <div class="detail-item full-width">
                                    <div class="detail-label" data-i18n="lbl_institution">Institution Name</div>
                                    <div class="detail-value" id="detail-institution">-</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label" data-i18n="lbl_inst_type">Institution Type</div>
                                    <div class="detail-value" id="detail-inst-type">-</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label" data-i18n="lbl_authority">Affiliated Authority</div>
                                    <div class="detail-value" id="detail-authority">-</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label" data-i18n="lbl_course">Course</div>
                                    <div class="detail-value" id="detail-course">-</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label" data-i18n="lbl_branch">Branch Code</div>
                                    <div class="detail-value" id="detail-branch">-</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label" data-i18n="lbl_mode">Mode of Study</div>
                                    <div class="detail-value" id="detail-mode">-</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label" data-i18n="lbl_admission_type">Admission Type</div>
                                    <div class="detail-value" id="detail-admission-type">-</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label" data-i18n="lbl_semester">Current Semester</div>
                                    <div class="detail-value" id="detail-semester">-</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label" data-i18n="lbl_status">Academic Status</div>
                                    <div class="detail-value" id="detail-status">-</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label" data-i18n="lbl_batch">Batch</div>
                                    <div class="detail-value" id="detail-batch">-</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label" data-i18n="lbl_completion">Expected Completion</div>
                                    <div class="detail-value" id="detail-completion">-</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- SECTION 3: Institution Identifiers -->
                    <div class="section-card">
                        <div class="section-card-header">
                            üÜî <span data-i18n="lbl_inst_identifiers">Institution Identifiers</span>
                        </div>
                        <div class="section-card-body">
                            <div class="detail-grid">
                                <div class="detail-item">
                                    <div class="detail-label" data-i18n="lbl_admission_no">College Admission Number
                                    </div>
                                    <div class="detail-value" id="detail-admission-no">-</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label" data-i18n="lbl_register_no">Polytechnic Register Number
                                    </div>
                                    <div class="detail-value" id="detail-register-no">-</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label" data-i18n="lbl_exam_no">Exam Registration Number</div>
                                    <div class="detail-value" id="detail-exam-no">-</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label" data-i18n="lbl_roll_no">Roll Number</div>
                                    <div class="detail-value" id="detail-roll-no">-</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- SECTION 4: Academic History Table -->
                    <div class="section-card">
                        <div class="section-card-header">
                            üìö <span data-i18n="lbl_academic_history">Academic History</span>
                        </div>
                        <div class="section-card-body" style="padding: 0;">
                            <table class="academic-table" id="academic-table">
                                <thead>
                                    <tr>
                                        <th data-i18n="tbl_qual">Qualification</th>
                                        <th data-i18n="tbl_inst">Institution</th>
                                        <th data-i18n="tbl_board">Board / Authority</th>
                                        <th data-i18n="tbl_year">Year</th>
                                        <th data-i18n="tbl_status">Status</th>
                                    </tr>
                                </thead>
                                <tbody id="academic-table-body">
                                    <!-- Rows will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- SECTION 5: USDI Verification Details -->
                    <div class="section-card">
                        <div class="section-card-header">
                            ‚úÖ <span data-i18n="lbl_verification_details">USDI Verification Details</span>
                        </div>
                        <div class="section-card-body">
                            <div class="detail-grid">
                                <div class="detail-item">
                                    <div class="detail-label" data-i18n="lbl_account_status">USDI Account Status</div>
                                    <div class="detail-value">
                                        <span class="verification-badge" id="verification-status">‚úì Verified</span>
                                    </div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label" data-i18n="lbl_qr_status">QR Code Status</div>
                                    <div class="detail-value" id="qr-status">-</div>
                                </div>
                                <div class="detail-item full-width">
                                    <div class="detail-label" data-i18n="lbl_verify_methods">Verification Methods
                                        Enabled</div>
                                    <div class="detail-value" id="verification-methods">-</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label" data-i18n="lbl_updated_by">Last Updated By</div>
                                    <div class="detail-value" id="updated-by">-</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label" data-i18n="lbl_updated_date">Last Updated Date</div>
                                    <div class="detail-value" id="updated-date">-</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- SECTION 6: Government Fields -->
                    <div class="section-card">
                        <div class="section-card-header">
                            üèõÔ∏è <span data-i18n="lbl_gov_fields">Government Record Information</span>
                        </div>
                        <div class="section-card-body">
                            <div class="detail-grid">
                                <div class="detail-item">
                                    <div class="detail-label" data-i18n="lbl_identity_type">Identity Type</div>
                                    <div class="detail-value" id="identity-type">-</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label" data-i18n="lbl_record_auth">Record Authority</div>
                                    <div class="detail-value" id="record-authority">-</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label" data-i18n="lbl_data_source">Data Source</div>
                                    <div class="detail-value" id="data-source">-</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label" data-i18n="lbl_data_usage">Data Usage</div>
                                    <div class="detail-value" id="data-usage">-</div>
                                </div>
                            </div>
                            <div class="govt-note">
                                <p data-i18n="msg_demo_note">‚ö†Ô∏è <strong>Note:</strong> All data shown is sample data for
                                    prototype demonstration
                                    purposes. No real government database is connected. This data is for prototype,
                                    presentation, and evaluation only.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <p>¬© 2026 Unified Student Digital ID System (USDI) - Prototype</p>
        </div>
    </footer>

    <!-- Share Modal -->
    <div class="modal-overlay" id="share-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Share Verification Link</h3>
                <button class="modal-close" onclick="closeShareModal()">√ó</button>
            </div>
            <div class="modal-body">
                <p class="mb-4">Share this link with employers or verifiers to confirm your student status:</p>
                <div style="display: flex; gap: var(--space-2);">
                    <input type="text" id="share-link" class="form-input" readonly>
                    <button class="btn btn-primary" onclick="copyLink()">Copy</button>
                </div>
                <p class="form-hint mt-4">This link allows anyone to verify your current academic status.</p>
            </div>
        </div>
    </div>

    <!-- Edit Request Modal -->
    <div class="modal-overlay" id="edit-request-modal">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #fef3c7, #fde68a);">
                <h3 class="modal-title" style="color: #92400e;">‚úèÔ∏è Request Record Edit</h3>
                <button class="modal-close" onclick="closeEditRequestModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div
                    style="background: var(--info-light); padding: var(--space-3); border-radius: var(--radius); margin-bottom: var(--space-4);">
                    <p style="margin: 0; color: var(--info);">
                        <strong>üìã Note:</strong> Edit requests will be reviewed by Government officials.
                        You'll be notified once your request is processed.
                    </p>
                </div>

                <form id="edit-request-form" onsubmit="submitEditRequest(event)">
                    <div class="form-group">
                        <label class="form-label">What would you like to change? *</label>
                        <select id="edit-field" class="form-select" required onchange="updateFieldInputs()">
                            <option value="">Select a field</option>
                            <option value="dateOfBirth">Date of Birth</option>
                            <option value="fullName">Full Name (Spelling Correction)</option>
                            <option value="sslcBoard">SSLC Board Name</option>
                            <option value="sslcSchool">SSLC School Name</option>
                            <option value="plusTwoSchool">Plus Two School Name</option>
                            <option value="category">Category (SC/ST/OBC/EWS)</option>
                            <option value="other">Other</option>
                        </select>
                    </div>

                    <div class="form-group" id="current-value-group">
                        <label class="form-label">Current Value</label>
                        <input type="text" id="current-value" class="form-input"
                            placeholder="Enter current incorrect value">
                        <input type="date" id="current-value-date" class="form-input hidden">
                    </div>

                    <div class="form-group" id="new-value-group">
                        <label class="form-label">New/Correct Value *</label>
                        <input type="text" id="new-value" class="form-input" placeholder="Enter correct value">
                        <input type="date" id="new-value-date" class="form-input hidden" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Reason for Change *</label>
                        <textarea id="edit-reason" class="form-input" rows="3"
                            placeholder="Please explain why this change is needed (e.g., spelling error, wrong data entry, etc.)"
                            required></textarea>
                    </div>

                    <div class="modal-footer"
                        style="padding: var(--space-4) 0 0; border: 0; display: flex; justify-content: space-between;">
                        <button type="button" class="btn btn-secondary"
                            onclick="closeEditRequestModal()">Cancel</button>
                        <button type="submit" class="btn btn-lg"
                            style="background: linear-gradient(135deg, #92400e, #b8860b); color: white;">
                            üì§ Submit Request
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="../js/theme.js"></script>
    <script src="../js/toast.js"></script>
    <script src="../js/translations.js"></script>
    <script src="../js/language.js"></script>
    <script src="../js/chatbot.js"></script>
    <script src="../js/data.js"></script>
    <script>
        let currentStudent = null;

        // Check authentication
        function checkAuth() {
            const isLoggedIn = sessionStorage.getItem('usdi_student_logged_in');
            const usn = sessionStorage.getItem('usdi_student_usn');
            const mobile = sessionStorage.getItem('usdi_student_mobile');

            if (!isLoggedIn) {
                window.location.href = 'login.html';
                return;
            }

            // Try to load by USN first, then by mobile for pending students
            if (usn) {
                currentStudent = USDI_DATA.getStudentByUSN(usn);
            } else if (mobile) {
                currentStudent = USDI_DATA.getStudentByMobile(mobile);
            }

            if (!currentStudent) {
                sessionStorage.clear();
                window.location.href = 'login.html';
                return;
            }

            renderDashboard();
        }

        function getBadgeClass(status) {
            if (status === 'Verified' || status === 'Approved') return 'status-completed';
            if (status === 'Pending') return 'status-ongoing';
            return '';
        }

        function renderDashboard() {
            const student = currentStudent;
            console.log('Rendering student:', student);

            try {
                // Welcome header
                document.getElementById('student-name').textContent = (student.fullName || 'Student').split(' ')[0];

                // Verification Banner Logic - Handle new workflow states
                const banner = document.getElementById('verification-banner');
                const status = student.status || student.verification?.accountStatus;

                // Check if NOT fully verified
                const isFullyVerified =
                    status === 'Verified by Government' ||
                    status === 'Active' ||
                    status === 'Graduated';

                if (!isFullyVerified) {
                    banner.classList.remove('hidden');

                    // Update banner text based on status
                    const statusInst = document.getElementById('status-inst');
                    const statusGovt = document.getElementById('status-govt');

                    if (status === 'Pending Institution Verification') {
                        statusInst.textContent = 'Institution: Pending';
                        statusInst.className = 'method-tag status-ongoing';
                        statusGovt.textContent = 'Government: Waiting';
                        statusGovt.className = 'method-tag';
                    } else if (status === 'Verified by Institution') {
                        statusInst.textContent = 'Institution: ‚úì Verified';
                        statusInst.className = 'method-tag status-completed';
                        statusGovt.textContent = 'Government: Pending';
                        statusGovt.className = 'method-tag status-ongoing';
                    } else if (status === 'Rejected') {
                        statusInst.textContent = 'Status: Rejected';
                        statusInst.className = 'method-tag status-rejected';
                        statusGovt.textContent = student.rejectionReason || 'Application rejected';
                        statusGovt.className = 'method-tag';
                    } else {
                        // Legacy/other pending states
                        statusInst.textContent = student.verification?.currentStudy ? `Institute: ${student.verification.currentStudy}` : 'Pending';
                        statusInst.className = 'method-tag status-ongoing';
                        statusGovt.textContent = student.verification?.previousEducation ? `Government: ${student.verification.previousEducation}` : 'Pending';
                        statusGovt.className = 'method-tag status-ongoing';
                    }
                } else {
                    banner.classList.add('hidden');
                }

                // Handle pending students (no USN yet)
                const idCardContainer = document.querySelector('.id-card-perspective');
                const actionButtons = document.querySelector('.flex.gap-4.mt-6');
                const pendingMessage = document.getElementById('pending-id-message');
                const pendingStatusText = document.getElementById('pending-status-text');

                if (!student.usn) {
                    // Student doesn't have USN yet - hide ID card, show pending message
                    if (idCardContainer) idCardContainer.style.display = 'none';
                    if (actionButtons) actionButtons.style.display = 'none';
                    if (pendingMessage) pendingMessage.classList.remove('hidden');
                    if (pendingStatusText) pendingStatusText.textContent = status || 'Pending Verification';
                } else {
                    // Student has USN - show ID card
                    if (pendingMessage) pendingMessage.classList.add('hidden');
                    if (idCardContainer) idCardContainer.style.display = 'block';
                    if (actionButtons) actionButtons.style.display = 'flex';

                    // ID Card
                    document.getElementById('card-name').textContent = student.fullName || '-';
                    document.getElementById('card-usn').textContent = "USID: " + (student.usn || '-');
                    document.getElementById('card-institution').textContent = student.institution || '-';
                    document.getElementById('card-course').textContent = student.course || '-';
                    document.getElementById('card-dob').textContent = formatDate(student.dob) || '-';

                    // Status badge on card
                    const statusBadge = document.getElementById('card-status');
                    const cardStatus = student.status || 'Active';
                    statusBadge.textContent = cardStatus;
                    // Optional: Update color based on status if needed, currently using default green
                    statusBadge.className = `card-status-badge ${cardStatus.toLowerCase().replace(/ /g, '-')}`;


                    // Generate QR Code with better error handling and visibility
                    const qrContainer = document.getElementById('qr-code');
                    try {
                        // Check if QRCode library is loaded
                        if (typeof QRCode === 'undefined') {
                            throw new Error('QRCode library not loaded');
                        }

                        // Robust URL generation relative to current page
                        // Use absolute path to ensure robustness
                        const verifyUrl = new URL('../verifier/verify.html', window.location.href);
                        verifyUrl.searchParams.set('usn', student.usn);

                        console.log('Generating QR for:', verifyUrl.href);

                        // Generate QR
                        // Using deep blue color for modern look
                        QRCode.toCanvas(document.createElement('canvas'), verifyUrl.href, {
                            width: 140,
                            margin: 0,
                            color: {
                                dark: '#1e3a8a', /* Deep Blue */
                                light: '#ffffff'
                            }
                        }, (err, canvas) => {
                            if (err) {
                                console.error('QR Generation Error:', err);
                                qrContainer.innerHTML = '<div style="color:red; font-size:10px;">QR Error</div>';
                                return;
                            }

                            qrContainer.innerHTML = '';
                            qrContainer.appendChild(canvas);
                            // Ensure canvas fits container styles and has rounded corners
                            canvas.style.borderRadius = '8px';
                            canvas.style.maxWidth = '100%';
                            canvas.style.height = 'auto';
                            canvas.style.display = 'block';
                        });
                    } catch (qrErr) {
                        console.error('QR Code critical error:', qrErr);
                        qrContainer.innerHTML = '<div style="color:red; font-size:10px;">QR Failed</div>';
                    }
                } // Close else block for USN check

                console.log('Rendering Section 1: Personal Details');
                // SECTION 1: Personal Details
                document.getElementById('detail-name').textContent = student.fullName || '-';
                document.getElementById('detail-dob').textContent = student.dobFormatted || formatDate(student.dob) || '-';
                document.getElementById('detail-gender').textContent = student.gender || '-';
                document.getElementById('detail-mobile').textContent = student.mobile || '-';
                document.getElementById('detail-email').textContent = student.email || '-';
                document.getElementById('detail-usn').textContent = student.usn || '-';
                document.getElementById('detail-nationality').textContent = student.nationality || 'Indian';
                document.getElementById('detail-location').textContent = `${student.state || 'Kerala'}, ${student.district || '-'}`;

                console.log('Rendering Section 2: Current Institution');
                // SECTION 2: Current Institution
                document.getElementById('detail-institution').textContent = student.institution || '-';
                document.getElementById('detail-inst-type').textContent = student.institutionType || '-';
                document.getElementById('detail-authority').textContent = student.affiliatedAuthority || '-';
                document.getElementById('detail-course').textContent = student.course || '-';
                document.getElementById('detail-branch').textContent = student.branchCode || '-';
                document.getElementById('detail-mode').textContent = student.modeOfStudy || 'Regular';
                document.getElementById('detail-admission-type').textContent = student.admissionType || '-';
                document.getElementById('detail-semester').textContent = student.semesterYear || '-';
                document.getElementById('detail-status').innerHTML = `<span class="badge badge-${status.toLowerCase()}">${status}</span>`;
                document.getElementById('detail-batch').textContent = student.batch || '-';
                document.getElementById('detail-completion').textContent = student.expectedCompletionYear || '-';
            } catch (err) {
                console.error('Error rendering dashboard:', err);
            }

            console.log('Rendering Section 3: Institution Identifiers');
            // SECTION 3: Institution Identifiers
            if (student.institutionIdentifiers) {
                document.getElementById('detail-admission-no').textContent = student.institutionIdentifiers.collegeAdmissionNumber || '-';
                document.getElementById('detail-register-no').textContent = student.institutionIdentifiers.polytechnicRegisterNumber || '-';
                document.getElementById('detail-exam-no').textContent = student.institutionIdentifiers.examRegistrationNumber || '-';
                document.getElementById('detail-roll-no').textContent = student.institutionIdentifiers.rollNumber || '-';
            }

            console.log('Rendering Section 4: Academic History Table');
            // SECTION 4: Academic History Table
            const tableBody = document.getElementById('academic-table-body');
            if (student.academicHistoryTable && student.academicHistoryTable.length > 0) {
                tableBody.innerHTML = student.academicHistoryTable.map(item => `
                    <tr>
                        <td><strong>${item.qualification}</strong></td>
                        <td>${item.institution}</td>
                        <td>${item.board}</td>
                        <td>${item.year}</td>
                        <td><span class="status-pill status-${(item.status || 'completed').toLowerCase()}">${item.status}</span></td>
                    </tr>
                `).join('');
            } else {
                tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: var(--grey-500);">No academic history available</td></tr>';
            }

            console.log('Rendering Section 5: Verification Details');
            // SECTION 5: Verification Details
            if (student.verification) {
                document.getElementById('verification-status').innerHTML = `‚úì ${student.verification.accountStatus}`;
                document.getElementById('qr-status').textContent = student.verification.qrCodeStatus || 'Active';
                document.getElementById('verification-methods').innerHTML = (student.verification.methods || []).map(m =>
                    `<span class="method-tag">‚úì ${m}</span>`
                ).join('');
                document.getElementById('updated-by').textContent = student.verification.lastUpdatedBy || '-';
                document.getElementById('updated-date').textContent = student.verification.lastUpdatedDate || '-';
            }

            console.log('Rendering Section 6: Government Fields');
            // SECTION 6: Government Fields
            if (student.governmentFields) {
                document.getElementById('identity-type').textContent = student.governmentFields.identityType || '-';
                document.getElementById('record-authority').textContent = student.governmentFields.recordAuthority || '-';
                document.getElementById('data-source').textContent = student.governmentFields.dataSource || '-';
                document.getElementById('data-usage').textContent = student.governmentFields.dataUsage || '-';
            }

            console.log('Dashboard rendering complete');

            // Load saved photo if available
            loadSavedPhoto();
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-IN', { day: 'numeric', month: 'long', year: 'numeric' });
        }

        // Photo Upload Functions
        function handlePhotoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Validate file type
            if (!file.type.startsWith('image/')) {
                showError('Please select an image file');
                return;
            }

            // Validate file size (max 2MB)
            if (file.size > 2 * 1024 * 1024) {
                showError('Image must be smaller than 2MB');
                return;
            }

            const reader = new FileReader();
            reader.onload = function (e) {
                const base64 = e.target.result;

                // Update preview
                document.getElementById('photo-placeholder').style.display = 'none';
                const photoImg = document.getElementById('photo-image');
                photoImg.src = base64;
                photoImg.style.display = 'block';

                // Save to localStorage
                if (currentStudent) {
                    localStorage.setItem(`usdi_photo_${currentStudent.usn}`, base64);
                    showSuccess('Photo uploaded successfully!');
                }
            };
            reader.readAsDataURL(file);
        }

        function loadSavedPhoto() {
            if (!currentStudent) return;

            const savedPhoto = localStorage.getItem(`usdi_photo_${currentStudent.usn}`);
            if (savedPhoto) {
                document.getElementById('photo-placeholder').style.display = 'none';
                const photoImg = document.getElementById('photo-image');
                photoImg.src = savedPhoto;
                photoImg.style.display = 'block';
            }
        }

        // Print ID Card Function
        function printIDCard() {
            // Add print class to body
            document.body.classList.add('printing-id');

            // Trigger print
            window.print();

            // Remove print class after print dialog closes
            setTimeout(() => {
                document.body.classList.remove('printing-id');
            }, 500);

            showSuccess('Print dialog opened!');
        }

        async function downloadPDF() {
            // Target both faces
            const frontFace = document.querySelector('.id-card-front');
            const backFace = document.querySelector('.id-card-back');

            if (!frontFace || !backFace) {
                showToast('Error: Card elements not found', 'error');
                return;
            }

            const btn = document.querySelector('button[onclick="downloadPDF()"]');
            const originalText = btn ? btn.innerHTML : 'Download ID Card';
            if (btn) {
                btn.innerHTML = 'Generating...';
                btn.style.opacity = '0.7';
                btn.disabled = true;
            }

            // Create visible overlay to FORCE rendering
            // Use absolute positioning with auto height to prevent viewport clipping
            const overlay = document.createElement('div');
            overlay.id = 'pdf-gen-overlay';
            overlay.style.position = 'absolute';
            overlay.style.top = '0';
            overlay.style.left = '0';
            overlay.style.width = '100%';
            overlay.style.minHeight = '100vh';
            overlay.style.background = '#ffffff';
            overlay.style.zIndex = '1000000';
            overlay.style.display = 'flex';
            overlay.style.flexDirection = 'column';
            overlay.style.alignItems = 'center';
            overlay.style.justifyContent = 'flex-start';
            overlay.style.paddingTop = '50px';
            overlay.innerHTML = '<h2 style="font-family:sans-serif; color:#333; margin-bottom:20px;">Generating PDF...</h2>';

            // Container for the actual content to print
            const printContent = document.createElement('div');
            printContent.style.background = 'white';
            printContent.style.padding = '20px';
            printContent.style.display = 'flex';
            printContent.style.flexDirection = 'column';
            printContent.style.gap = '40px';
            printContent.style.alignItems = 'center';
            printContent.style.width = 'fit-content';

            // Helper to prepare a clone
            const prepareClone = (original, labelText) => {
                const clone = original.cloneNode(true);

                // CRITICAL: Manually copy Canvas content (QR Code)
                const originalCanvases = original.querySelectorAll('canvas');
                const clonedCanvases = clone.querySelectorAll('canvas');

                originalCanvases.forEach((origCanvas, index) => {
                    const clonedCanvas = clonedCanvases[index];
                    if (clonedCanvas) {
                        const ctx = clonedCanvas.getContext('2d');
                        ctx.drawImage(origCanvas, 0, 0);
                    }
                });

                // Force Flattening & Visibility
                clone.style.position = 'relative';
                clone.style.transform = 'none';
                clone.style.transition = 'none';
                clone.style.backfaceVisibility = 'visible';
                clone.style.opacity = '1';
                clone.style.display = 'flex';
                clone.style.boxShadow = 'none';
                clone.style.border = '1px solid #eee';
                clone.style.margin = '0';

                // Fixed Dimensions
                clone.style.width = '480px';
                clone.style.height = '300px';
                clone.style.borderRadius = '20px';

                const label = document.createElement('div');
                label.textContent = labelText;
                label.style.fontFamily = 'sans-serif';
                label.style.textAlign = 'center';
                label.style.marginBottom = '10px';
                label.style.color = '#666';
                label.style.fontWeight = 'bold';
                label.style.textTransform = 'uppercase';

                const container = document.createElement('div');
                container.appendChild(label);
                container.appendChild(clone);
                return container;
            };

            printContent.appendChild(prepareClone(frontFace, 'Front Side'));
            printContent.appendChild(prepareClone(backFace, 'Back Side'));

            overlay.appendChild(printContent);
            document.body.appendChild(overlay);

            // Scroll to top to ensure capture starts correctly
            window.scrollTo(0, 0);

            // Wait for render
            await new Promise(resolve => setTimeout(resolve, 800));

            const opt = {
                margin: 10,
                filename: `USDI_${currentStudent.usn}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: {
                    scale: 3, // Increased scale for better quality
                    useCORS: true,
                    backgroundColor: '#ffffff',
                    scrollY: 0
                },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            try {
                await html2pdf().set(opt).from(printContent).save();
                showSuccess('ID Card downloaded!');
            } catch (err) {
                console.error('PDF Error:', err);
                showError('Failed to generate PDF');
            } finally {
                document.body.removeChild(overlay);
                if (btn) {
                    btn.innerHTML = originalText;
                    btn.style.opacity = '1';
                    btn.disabled = false;
                }
            }
        }

        async function shareLink() {
            // Construct absolute URL relative to current page
            // Works for both file:// and http://
            const verifyUrl = new URL('../verifier/verify.html', window.location.href);
            verifyUrl.searchParams.set('usn', currentStudent.usn);
            const finalUrl = verifyUrl.href;

            // Try Web Share API (Mobile/Modern Browsers)
            if (navigator.share) {
                try {
                    await navigator.share({
                        title: 'USDI Verification',
                        text: `Verify my student identity: ${currentStudent.fullName}`,
                        url: finalUrl
                    });
                    return; // Shared successfully
                } catch (error) {
                    console.log('Share failed or cancelled:', error);
                    // Fallback to modal
                }
            }

            // Fallback: Show Modal
            document.getElementById('share-link').value = finalUrl;
            document.getElementById('share-modal').classList.add('active');
        }

        function closeShareModal() {
            document.getElementById('share-modal').classList.remove('active');
        }

        function copyLink() {
            const linkInput = document.getElementById('share-link');
            linkInput.select();
            document.execCommand('copy');
            showSuccess('Link copied to clipboard!');
        }

        function logout() {
            sessionStorage.clear();
            window.location.href = 'login.html';
        }

        // Close modal on outside click
        document.getElementById('share-modal').addEventListener('click', (e) => {
            if (e.target.classList.contains('modal-overlay')) {
                closeShareModal();
            }
        });

        // Edit Request Modal
        function openEditRequestModal() {
            document.getElementById('edit-request-form').reset();
            document.getElementById('edit-request-modal').classList.add('active');
        }

        function closeEditRequestModal() {
            document.getElementById('edit-request-modal').classList.remove('active');
        }



        function updateFieldInputs() {
            const field = document.getElementById('edit-field').value;
            const isDateField = (field === 'dateOfBirth');

            // Toggle between text and date inputs
            document.getElementById('current-value').classList.toggle('hidden', isDateField);
            document.getElementById('current-value-date').classList.toggle('hidden', !isDateField);
            document.getElementById('new-value').classList.toggle('hidden', isDateField);
            document.getElementById('new-value-date').classList.toggle('hidden', !isDateField);

            // Update required attribute
            document.getElementById('new-value').required = !isDateField;
            document.getElementById('new-value-date').required = isDateField;

            // Auto-fill current value based on selected field
            if (currentStudent) {
                switch (field) {
                    case 'dateOfBirth':
                        document.getElementById('current-value-date').value = currentStudent.dob || '';
                        break;
                    case 'fullName':
                        document.getElementById('current-value').value = currentStudent.fullName || '';
                        break;
                    case 'category':
                        document.getElementById('current-value').value = currentStudent.category || currentStudent.studentCategory || '';
                        break;
                    default:
                        document.getElementById('current-value').value = '';
                }
            }
        }

        function submitEditRequest(e) {
            e.preventDefault();

            const field = document.getElementById('edit-field').value;
            const isDateField = (field === 'dateOfBirth');

            // Get values from correct inputs
            const currentValue = isDateField
                ? document.getElementById('current-value-date').value
                : document.getElementById('current-value').value.trim();
            const newValue = isDateField
                ? document.getElementById('new-value-date').value
                : document.getElementById('new-value').value.trim();
            const reason = document.getElementById('edit-reason').value.trim();

            // Validate
            if (!newValue) {
                showWarning('Please enter the new/correct value.');
                return;
            }

            // Create change object
            const changes = {};
            changes[field] = { old: currentValue, new: newValue };

            // Build description
            const fieldNames = {
                'dateOfBirth': 'Date of Birth',
                'fullName': 'Full Name',
                'sslcBoard': 'SSLC Board Name',
                'sslcSchool': 'SSLC School Name',
                'plusTwoSchool': 'Plus Two School Name',
                'category': 'Category',
                'other': 'Other Field'
            };
            const description = `Request to update ${fieldNames[field] || field}: "${currentValue}" to "${newValue}". Reason: ${reason}`;

            // Submit to USDI_DATA
            const request = USDI_DATA.addEditRequest(
                currentStudent.usn,
                currentStudent.fullName,
                description,
                changes
            );

            console.log('Edit request submitted:', request);

            showSuccess('Your edit request has been submitted! Request ID: ' + request.id);
            closeEditRequestModal();
        }

        // Close edit request modal on outside click
        document.getElementById('edit-request-modal').addEventListener('click', (e) => {
            if (e.target.classList.contains('modal-overlay')) {
                closeEditRequestModal();
            }
        });

        // Copy USN to Clipboard
        function copyUSN(btn) {
            if (!currentStudent || !currentStudent.usn) return;

            navigator.clipboard.writeText(currentStudent.usn).then(() => {
                // Animation: Scale Down
                if (btn) {
                    btn.style.transform = "scale(0.8)";
                    setTimeout(() => btn.style.transform = "scale(1)", 150);

                    // Icon Swap: Change to Check
                    const originalHTML = btn.innerHTML;
                    btn.innerHTML = `
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="20 6 9 17 4 12"></polyline>
                        </svg>`;

                    // Revert after 2 seconds
                    setTimeout(() => {
                        btn.innerHTML = originalHTML;
                    }, 2000);
                }

                const feedback = document.getElementById('copy-feedback');
                if (feedback) {
                    feedback.style.opacity = '1';
                    setTimeout(() => {
                        feedback.style.opacity = '0';
                    }, 2000);
                }
            }).catch(err => {
                console.error('Failed to copy: ', err);
            });
        }

        // Initialize
        checkAuth();
    </script>
</body>

</html>