<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="USDI Student Verification Portal - Instantly verify student identity and status">
    <title>Verify Student - USDI</title>
    <link rel="stylesheet" href="../css/styles.css">
</head>

<body>
    <!-- Mobile Overlay -->
    <div class="mobile-overlay" onclick="closeMobileMenu()"></div>

    <!-- Header -->
    <header class="header">
        <div class="container">
            <a href="../index.html" class="logo">
                <div class="logo-icon">üéì</div>
                <span>USDI</span>
            </a>
            <nav class="nav">
                <a href="../student/login.html" data-i18n="nav_student">Student</a>
                <a href="../institution/login.html" data-i18n="nav_institution">Institution</a>
                <a href="verify.html" class="active" data-i18n="nav_verifier">Verifier</a>
                <div class="language-wrapper">
                    <div class="custom-dropdown" id="language-dropdown">
                        <div class="dropdown-trigger" role="button" aria-haspopup="listbox" aria-expanded="false"
                            tabindex="0">
                            <span>üá∫üá∏ English</span>
                            <span class="dropdown-icon">‚ñº</span>
                        </div>
                        <div class="dropdown-options" role="listbox">
                            <div class="dropdown-option selected" data-value="en" role="option" aria-selected="true"
                                tabindex="0">
                                <span>üá∫üá∏ English</span>
                            </div>
                            <div class="dropdown-option" data-value="ml" role="option" aria-selected="false"
                                tabindex="0">
                                <span>üáÆüá≥ ‡¥Æ‡¥≤‡¥Ø‡¥æ‡¥≥‡¥Ç</span>
                            </div>
                            <div class="dropdown-option" data-value="hi" role="option" aria-selected="false"
                                tabindex="0">
                                <span>üáÆüá≥ ‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</span>
                            </div>
                        </div>
                    </div>
                </div>
                <button class="theme-toggle" onclick="toggleTheme()" title="Toggle Theme">
                    <span class="theme-icon moon">üåô</span>
                    <span class="theme-icon sun">‚òÄÔ∏è</span>
                </button>
            </nav>
            <button class="menu-toggle" onclick="toggleMobileMenu()" aria-label="Toggle Menu">
                <span></span>
                <span></span>
                <span></span>
            </button>
        </div>
    </header>
    <div class="mobile-overlay" onclick="closeMobileMenu()"></div>

    <!-- Main Content -->
    <main class="page-section">
        <div class="container container-sm">
            <!-- Verification Box -->
            <div class="card">
                <div class="card-header text-center">
                    <h2 style="margin: 0;" data-i18n="verifier_page_title">Student Verification</h2>
                    <p class="text-muted text-sm" style="margin: var(--space-2) 0 0;"
                        data-i18n="verifier_page_subtitle">Instantly verify student identity
                        and academic status</p>
                </div>
                <div class="card-body">
                    <!-- Search Form -->
                    <div id="search-section">
                        <div class="form-group">
                            <label class="form-label" data-i18n="lbl_usn">Enter Unique Student Number (USN)</label>
                            <input type="text" id="usn-input" class="form-input form-input-lg"
                                placeholder="e.g., USDI2024001" style="text-transform: uppercase;" data-i18n="ph_usn">
                            <p class="form-hint" data-i18n="hint_mobile">Enter the student's USN to verify their current
                                status</p>
                        </div>
                        <button class="btn btn-primary btn-lg btn-block" onclick="verifyStudent()"
                            data-i18n="btn_verify_check">
                            üîç Verify Student
                        </button>

                        <div class="text-center mt-6">
                            <p class="text-muted text-sm mb-4">‚Äî OR ‚Äî</p>
                            <button class="btn btn-outline btn-block" onclick="simulateQRScan()"
                                data-i18n="lbl_scan_qr">
                                üì∑ Scan QR Code
                            </button>
                            <p class="form-hint mt-4" data-i18n="verify_feat_2">Scan the QR code on the student's
                                digital ID card</p>
                        </div>
                    </div>

                    <!-- Result Section -->
                    <div id="result-section" class="hidden">
                        <!-- Verified Result -->
                        <div id="verified-result" class="hidden">
                            <div class="verify-result">
                                <div class="verify-icon success">‚úì</div>
                                <div class="verify-status success" data-i18n="verify_success"
                                    style="margin-bottom: 5px;">VERIFIED</div>
                                <p class="text-muted" data-i18n="msg_verified_desc">This student is registered in the
                                    USDI system</p>
                            </div>

                            <div
                                style="background: var(--grey-50); border-radius: var(--radius-lg); padding: var(--space-6); margin-top: var(--space-6);">
                                <h4 style="margin-bottom: var(--space-4);" data-i18n="lbl_student_details">Student
                                    Details</h4>
                                <div class="grid" style="grid-template-columns: 1fr 1fr; gap: var(--space-4);">
                                    <div>
                                        <p class="text-xs text-muted"
                                            style="text-transform: uppercase; letter-spacing: 0.5px;">Full Name</p>
                                        <p id="result-name" style="font-weight: 600; font-size: 1.125rem;">-</p>
                                    </div>
                                    <div>
                                        <p class="text-xs text-muted"
                                            style="text-transform: uppercase; letter-spacing: 0.5px;">USN</p>
                                        <p id="result-usn" style="font-weight: 600;">-</p>
                                    </div>
                                    <div style="grid-column: span 2;">
                                        <p class="text-xs text-muted"
                                            style="text-transform: uppercase; letter-spacing: 0.5px;">Institution</p>
                                        <p id="result-institution" style="font-weight: 500;">-</p>
                                    </div>
                                    <div>
                                        <p class="text-xs text-muted"
                                            style="text-transform: uppercase; letter-spacing: 0.5px;">Course</p>
                                        <p id="result-course" style="font-weight: 500;">-</p>
                                    </div>
                                    <div>
                                        <p class="text-xs text-muted"
                                            style="text-transform: uppercase; letter-spacing: 0.5px;">Semester/Year</p>
                                        <p id="result-semester" style="font-weight: 500;">-</p>
                                    </div>
                                    <div style="grid-column: span 2;">
                                        <p class="text-xs text-muted"
                                            style="text-transform: uppercase; letter-spacing: 0.5px;">Current Status</p>
                                        <p id="result-status">-</p>
                                    </div>
                                </div>
                            </div>

                            <div
                                style="background: var(--success-light); border-radius: var(--radius); padding: var(--space-4); margin-top: var(--space-4); text-align: center;">
                                <p class="text-sm" style="color: var(--success);">
                                    ‚úì Verified on <span id="verify-timestamp">-</span>
                                </p>
                            </div>
                        </div>

                        <!-- Invalid Result -->
                        <div id="invalid-result" class="hidden">
                            <div class="verify-result">
                                <div class="verify-icon error">‚úï</div>
                                <div class="verify-status error">INVALID</div>
                                <p class="text-muted">No student found with this USN</p>
                            </div>

                            <div
                                style="background: var(--danger-light); border-radius: var(--radius); padding: var(--space-4); margin-top: var(--space-4); text-align: center;">
                                <p class="text-sm" style="color: var(--danger);">
                                    The entered USN does not exist in the system. Please check and try again.
                                </p>
                            </div>
                        </div>

                        <button class="btn btn-secondary btn-block mt-6" onclick="resetSearch()">
                            ‚Üê Verify Another Student
                        </button>
                    </div>
                </div>
            </div>

            <!-- Info Box -->
            <div class="card mt-6">
                <div class="card-body">
                    <h4 style="margin-bottom: var(--space-4);">About Verification</h4>
                    <ul style="list-style: none; display: flex; flex-direction: column; gap: var(--space-3);">
                        <li style="display: flex; gap: var(--space-3);">
                            <span style="color: var(--success);">‚úì</span>
                            <span class="text-sm">Verification is instant and reflects real-time student status</span>
                        </li>
                        <li style="display: flex; gap: var(--space-3);">
                            <span style="color: var(--success);">‚úì</span>
                            <span class="text-sm">No login required for verification</span>
                        </li>
                        <li style="display: flex; gap: var(--space-3);">
                            <span style="color: var(--success);">‚úì</span>
                            <span class="text-sm">Status updates by institutions reflect immediately</span>
                        </li>
                        <li style="display: flex; gap: var(--space-3);">
                            <span style="color: var(--success);">‚úì</span>
                            <span class="text-sm">QR codes on student ID cards link directly to verification</span>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Demo USNs -->
            <div class="card mt-6">
                <div class="card-body">
                    <h4 style="margin-bottom: var(--space-4);">Demo USNs for Testing</h4>
                    <div class="grid grid-2" style="gap: var(--space-3);">
                        <div style="background: linear-gradient(135deg, var(--primary-light), #dbeafe); padding: var(--space-3); border-radius: var(--radius); cursor: pointer; border: 2px solid var(--primary);"
                            onclick="fillUSN('USIDSN082006')">
                            <code style="color: var(--primary); font-weight: 700;">USIDSN082006</code> - Sabarinadh S R
                            (Active)
                        </div>
                        <div style="background: var(--grey-50); padding: var(--space-3); border-radius: var(--radius); cursor: pointer;"
                            onclick="fillUSN('USDI2024001')">
                            <code>USDI2024001</code> - Rahul Sharma (Active)
                        </div>
                        <div style="background: var(--grey-50); padding: var(--space-3); border-radius: var(--radius); cursor: pointer;"
                            onclick="fillUSN('USDI2023015')">
                            <code>USDI2023015</code> - Amit Kumar (Graduated)
                        </div>
                        <div style="background: var(--grey-50); padding: var(--space-3); border-radius: var(--radius); cursor: pointer;"
                            onclick="fillUSN('USDI2024003')">
                            <code>USDI2024003</code> - Sneha Reddy (Transferred)
                        </div>
                    </div>
                    <p class="form-hint mt-4">Click any USDI above to auto-fill and verify</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <p>¬© 2024 Unified Student Digital ID System (USDI)</p>
        </div>
    </footer>

    <!-- QR Scan Modal -->
    <div class="modal-overlay" id="qr-modal">
        <div class="modal" style="max-width: 450px;">
            <div class="modal-header">
                <h3 class="modal-title">üì∑ Scan QR Code</h3>
                <button class="modal-close" onclick="closeQRModal()">√ó</button>
            </div>
            <div class="modal-body text-center">
                <div id="qr-reader" style="width: 100%; min-height: 250px;"></div>
                <p id="qr-status" class="text-muted mb-4" style="margin-top: var(--space-3);">
                    Point your camera at the QR code on the student's digital ID
                </p>
                <div style="display: flex; gap: var(--space-3); justify-content: center; margin-top: var(--space-4);">
                    <button class="btn btn-primary" id="start-scan-btn" onclick="startQRScanner()">
                        üì∑ Start Camera
                    </button>
                    <button class="btn btn-secondary" id="stop-scan-btn" onclick="stopQRScanner()"
                        style="display: none;">
                        ‚èπ Stop Camera
                    </button>
                </div>
                <p class="text-sm mt-4"
                    style="background: var(--info-light); color: var(--info); padding: var(--space-3); border-radius: var(--radius);">
                    üì± Allow camera access when prompted. QR codes link directly to student verification.
                </p>
                <button class="btn btn-outline btn-block mt-4" onclick="doSimulatedScan()">
                    üé≠ Simulate Scan (Demo Mode)
                </button>
            </div>
        </div>
    </div>

    <!-- html5-qrcode library -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

    <script src="../js/theme.js"></script>
    <script src="../js/toast.js"></script>
    <script src="../js/data.js"></script>
    <script src="../js/translations.js"></script>
    <script src="../js/language.js"></script>
    <script>
        // Check for USN in URL params (from shared link or QR code)
        function checkURLParams() {
            const params = new URLSearchParams(window.location.search);
            const usn = params.get('usn');
            if (usn) {
                document.getElementById('usn-input').value = usn;
                verifyStudent();
            }
        }

        function verifyStudent() {
            const usn = document.getElementById('usn-input').value.trim().toUpperCase();

            if (!usn) {
                showWarning('Please enter a USN to verify');
                return;
            }

            const result = USDI_DATA.verifyStudent(usn);

            document.getElementById('search-section').classList.add('hidden');
            document.getElementById('result-section').classList.remove('hidden');

            if (result.verified) {
                showVerifiedResult(result.data);
            } else {
                showInvalidResult();
            }
        }

        function showVerifiedResult(data) {
            document.getElementById('verified-result').classList.remove('hidden');
            document.getElementById('invalid-result').classList.add('hidden');

            document.getElementById('result-name').textContent = data.fullName;
            document.getElementById('result-usn').textContent = data.usn;
            document.getElementById('result-institution').textContent = data.institution;
            document.getElementById('result-course').textContent = data.course;
            document.getElementById('result-semester').textContent = data.semesterYear;

            const statusBadge = `<span class="badge badge-lg badge-${data.status.toLowerCase()}">${data.status}</span>`;
            document.getElementById('result-status').innerHTML = statusBadge;

            const now = new Date();
            document.getElementById('verify-timestamp').textContent = now.toLocaleString('en-IN', {
                day: 'numeric',
                month: 'short',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function showInvalidResult() {
            document.getElementById('verified-result').classList.add('hidden');
            document.getElementById('invalid-result').classList.remove('hidden');
        }

        function resetSearch() {
            document.getElementById('usn-input').value = '';
            document.getElementById('search-section').classList.remove('hidden');
            document.getElementById('result-section').classList.add('hidden');
            document.getElementById('verified-result').classList.add('hidden');
            document.getElementById('invalid-result').classList.add('hidden');

            // Clear URL params
            window.history.replaceState({}, document.title, window.location.pathname);
        }

        function fillUSN(usn) {
            document.getElementById('usn-input').value = usn;
            verifyStudent();
        }

        function simulateQRScan() {
            document.getElementById('qr-modal').classList.add('active');
        }

        function closeQRModal() {
            document.getElementById('qr-modal').classList.remove('active');
        }

        function doSimulatedScan() {
            stopQRScanner(); // Stop scanner if running
            closeQRModal();
            // Simulate scanning - use a random demo USN
            const demoUSNs = ['USDI2024001', 'USDI2024002', 'USIDSN082006'];
            const randomUSN = demoUSNs[Math.floor(Math.random() * demoUSNs.length)];
            document.getElementById('usn-input').value = randomUSN;
            showSuccess(`Simulated scan: ${randomUSN}`);
            verifyStudent();
        }

        // Real QR Scanner using html5-qrcode
        let html5QrCode = null;

        function startQRScanner() {
            const qrReaderDiv = document.getElementById('qr-reader');

            // Clear any existing content
            qrReaderDiv.innerHTML = '';

            // Create new scanner instance
            html5QrCode = new Html5Qrcode('qr-reader');

            const config = {
                fps: 10,
                qrbox: { width: 200, height: 200 },
                aspectRatio: 1.0
            };

            html5QrCode.start(
                { facingMode: 'environment' }, // Back camera
                config,
                onScanSuccess,
                onScanError
            ).then(() => {
                document.getElementById('start-scan-btn').style.display = 'none';
                document.getElementById('stop-scan-btn').style.display = 'inline-flex';
                document.getElementById('qr-status').textContent = 'üé• Camera active - scanning for QR codes...';
            }).catch(err => {
                console.error('Camera start error:', err);
                showError('Could not access camera. Please check permissions.');
            });
        }

        function stopQRScanner() {
            if (html5QrCode && html5QrCode.isScanning) {
                html5QrCode.stop().then(() => {
                    document.getElementById('start-scan-btn').style.display = 'inline-flex';
                    document.getElementById('stop-scan-btn').style.display = 'none';
                    document.getElementById('qr-status').textContent = 'Point your camera at the QR code on the student\'s digital ID';
                }).catch(err => {
                    console.error('Stop error:', err);
                });
            }
        }

        function onScanSuccess(decodedText, decodedResult) {
            console.log('QR Scanned:', decodedText);

            // Try to extract USN from the scanned text
            let usn = null;

            // Check if it's a URL with usn parameter
            try {
                const url = new URL(decodedText);
                usn = url.searchParams.get('usn');
            } catch (e) {
                // Not a URL, check if it's a direct USN
                if (decodedText.match(/^USDI?[A-Z0-9]+$/i)) {
                    usn = decodedText.toUpperCase();
                }
            }

            if (usn) {
                showSuccess(`QR Code scanned: ${usn}`);
                stopQRScanner();
                closeQRModal();
                document.getElementById('usn-input').value = usn;
                verifyStudent();
            } else {
                showWarning('Invalid QR code format. Looking for USDI format...');
            }
        }

        function onScanError(error) {
            // Ignore scan errors - they happen constantly when no QR is in view
        }

        // Enter key handling
        document.getElementById('usn-input').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') verifyStudent();
        });

        // Close modal on outside click
        document.getElementById('qr-modal').addEventListener('click', (e) => {
            if (e.target.classList.contains('modal-overlay')) {
                closeQRModal();
            }
        });

        // Initialize
        checkURLParams();

        // Mobile Menu Toggle
        function toggleMobileMenu() {
            document.querySelector('.nav').classList.toggle('open');
            document.querySelector('.menu-toggle').classList.toggle('active');
            document.querySelector('.mobile-overlay').classList.toggle('active');
        }

        function closeMobileMenu() {
            document.querySelector('.nav').classList.remove('open');
            document.querySelector('.menu-toggle').classList.remove('active');
            document.querySelector('.mobile-overlay').classList.remove('active');
        }
    </script>
</body>

</html>